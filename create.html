<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (v5.4 - Final)</title>
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        h1, h2 { color: var(--text-dark); margin-top: 0; }
        h1 { border: none; padding: 0; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: var(--text-light); padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: start;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: var(--primary-color); color: var(--white-bg); padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { filter: brightness(90%); }
        button.secondary { background-color: var(--secondary-color); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .status-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; word-break: break-word; min-height: 1.5em;}
        .status-message.success, .suggestion-text.success { color: #155724; background-color: #d4edda; padding: 10px; border-radius: 4px;}
        .status-message.error, .suggestion-text.error { color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px;}
        .suggestion-text { font-size: 0.9em; color: var(--text-light); margin-top: 5px; min-height: 1.2em; }
        .suggestion-text.warning { color: var(--warning-color); font-weight: bold; }
        .suggestion-text ul { margin: 5px 0 0 20px; padding: 0; list-style-type: '‚ö†Ô∏è'; }
        .table-wrapper { margin-top: 20px; overflow-x: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background-color: #ecf0f1; position: sticky; top: 0; z-index: 1; text-align: center; }
        #create-sentence-table { min-width: 1200px; }
        #create-sentence-table th:nth-child(1), #create-sentence-table td:nth-child(1) { width: 50px; text-align: center; }
        #create-sentence-table th:nth-child(2), #create-sentence-table td:nth-child(2) { width: 60px; text-align: center; }
        #create-sentence-table th:nth-child(3), #create-sentence-table td:nth-child(3) { width: 80px; }
        #create-sentence-table th:nth-child(4) { width: 55%; }
        #create-sentence-table td input, #create-sentence-table td select, #create-sentence-table td textarea { width: 95%; box-sizing: border-box;}
        .delete-row-btn { cursor: pointer; color: var(--danger-color); font-weight: bold; font-size: 1.2em; border: none; background: none; padding: 0; }
        .draggable-row { cursor: move; }
        .dragging { background-color: #f0f8ff; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="header-bar">
            <div><h1 id="main-header">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1><p id="sub-header"></p></div>
            <a href="index.html"><button class="secondary">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç</button></a>
        </div>
        <div id="create-view">
            <h2 id="create-view-header">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏•‡∏µ)</h2>
            <fieldset> <legend>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</legend> <input type="text" id="user_name" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" required> </fieldset>
            <fieldset><legend>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</legend><div class="form-grid">
                <input type="text" id="chapter_name" placeholder="‡∏ß‡∏£‡∏£‡∏Ñ/‡∏ö‡∏ó" list="chapter_datalist"><datalist id="chapter_datalist"></datalist>
                <input type="text" id="story_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" list="story_datalist"><datalist id="story_datalist"></datalist>
                <input type="text" id="section_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô" list="section_datalist"><datalist id="section_datalist"></datalist>
                <select id="display_flag" required> <option value="2" selected>2 - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</option> <option value="1">1 - ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</option> <option value="0">0 - ‡∏£‡πà‡∏≤‡∏á</option> </select>
            </div></fieldset>
            <fieldset><legend>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Group ID, ‡∏´‡∏ô‡πâ‡∏≤, ‡πÅ‡∏•‡∏∞‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å*)</legend><div class="form-grid">
                <div> <label for="master_group_id">Group ID (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)*</label> <input type="number" id="master_group_id" placeholder="‡πÉ‡∏™‡πà ID ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"> <p id="group_id_suggestion" class="suggestion-text"></p></div>
                <div> <label for="master_page_start">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°*</label> <input type="number" id="master_page_start"> <p id="page_check_result" class="suggestion-text"></p> </div>
                <div> <label for="master_page_end">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏ö</label> <input type="number" id="master_page_end"> </div>
                <div> <label for="master_paragraph_num">‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤*</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div>
            </div></fieldset>
            <fieldset><legend>‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏≤‡∏•‡∏µ</legend>
                <textarea id="pali-input" rows="8"></textarea>
                <p id="hash_check_result" class="suggestion-text"></p>
                <div style="margin-top:10px; display:flex; gap: 10px; flex-wrap: wrap;">
                    <button id="clean-format-btn" class="secondary">‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î & ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</button>
                    <button id="merge-lines-btn" class="secondary">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</button>
                    <button id="undo-btn" class="secondary" style="display: none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="split-btn">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</button>
                </div>
            </fieldset>
            <div id="create-data-work-area" style="display: none;">
                <fieldset><legend>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</legend>
                    <div class="table-wrapper"><table id="create-sentence-table" style="width:100%"></table></div>
                    <button id="add-row-btn" class="secondary" style="margin-top: 10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á</button>
                </fieldset>
                <fieldset><legend>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</legend><button id="create-save-btn" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><div id="create-status-message" class="status-message"></div></fieldset>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDoe7sUNTdaK7uFxvi_Y16C4nCX4kKFiDA",
            authDomain: "pali-exam-builder.firebaseapp.com",
            projectId: "pali-exam-builder",
            storageBucket: "pali-exam-builder.appspot.com",
            messagingSenderId: "783124881115",
            appId: "1:783124881115:web:688f964e586df5b17d36fe",
            measurementId: "G-8HV8B03THV"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '', currentPrefix = '';
        let currentMode = 'create';
        let originalPaliText = ''; 
        let nextAvailableId = 1;
        let lastFoundGroupId = 0;
        let lastFoundParagraphNum = 0;

        document.addEventListener('DOMContentLoaded', () => {
            const createHeader = `<thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>ID</th><th>Group ID</th><th>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏≤‡∏•‡∏µ</th><th>‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏ö</th><th>‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody>`;
            const dom = {
                container: document.getElementById('container'), mainHeader: document.getElementById('main-header'), subHeader: document.getElementById('sub-header'),
                userNameInput: document.getElementById('user_name'), storyNameInput: document.getElementById('story_name'),
                masterPageStartInput: document.getElementById('master_page_start'), masterPageEndInput: document.getElementById('master_page_end'),
                paliInput: document.getElementById('pali-input'), masterGroupIdInput: document.getElementById('master_group_id'),
                masterParagraphNumInput: document.getElementById('master_paragraph_num'),
                createSaveBtn: document.getElementById('create-save-btn'),
                cleanFormatBtn: document.getElementById('clean-format-btn'),
                mergeLinesBtn: document.getElementById('merge-lines-btn'),
                undoBtn: document.getElementById('undo-btn'),
                splitBtn: document.getElementById('split-btn'), createDataWorkArea: document.getElementById('create-data-work-area'),
                createSentenceTable: document.getElementById('create-sentence-table'),
                addRowBtn: document.getElementById('add-row-btn'),
            };

            function updateStatus(elementId, message, type) { 
                const el = document.getElementById(elementId); 
                if(el){ 
                    el.innerHTML = message; 
                    el.className = `suggestion-text ${type}`; 
                    if(elementId.includes('status')) el.className = `status-message ${type}`; 
                } 
            }

            async function findLastId(field) { 
                const q = query(paliCollection, orderBy(field, "desc"), limit(1)); 
                const querySnapshot = await getDocs(q); 
                if (querySnapshot.empty) return 0; 
                return querySnapshot.docs[0].data()[field] || 0; 
            }
            
            // v5.1: ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Group ID
            function validateGroupId() { 
                const currentId = parseInt(dom.masterGroupIdInput.value); 
                if (currentMode === 'super-edit') { 
                    updateStatus('group_id_suggestion', '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å', ''); 
                    return true; 
                } 
                if (isNaN(currentId) || !currentId) { // Changed to check for NaN or empty
                    updateStatus('group_id_suggestion', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Group ID (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)', 'error'); 
                    return false;
                }
                if (currentId < lastFoundGroupId) { 
                    updateStatus('group_id_suggestion', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ID ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ ${lastFoundGroupId})`, 'error'); 
                    return false; 
                } else if (currentId > lastFoundGroupId + 1) { 
                    updateStatus('group_id_suggestion', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö ID ‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${lastFoundGroupId} ‡∏´‡∏£‡∏∑‡∏≠ ${lastFoundGroupId + 1})`, 'error'); 
                    return false; 
                } else { 
                    updateStatus('group_id_suggestion', '‚úÖ ID ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'success'); 
                    return true; 
                } 
            }

            // v5.1: ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
            function validateParagraphNum() { 
                const currentNum = parseInt(dom.masterParagraphNumInput.value); 
                if (currentMode === 'super-edit') { 
                    updateStatus('paragraph_suggestion', '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å', ''); 
                    return true; 
                } 
                if (isNaN(currentNum) || !currentNum) { // Changed to check for NaN or empty
                    updateStatus('paragraph_suggestion', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)', 'error'); 
                    return false;
                }
                if (currentNum < lastFoundParagraphNum) { 
                    updateStatus('paragraph_suggestion', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ ${lastFoundParagraphNum})`, 'error'); 
                    return false; 
                } else if (currentNum > lastFoundParagraphNum + 1) { 
                    updateStatus('paragraph_suggestion', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${lastFoundParagraphNum} ‡∏´‡∏£‡∏∑‡∏≠ ${lastFoundParagraphNum + 1})`, 'error'); 
                    return false; 
                } else { 
                    updateStatus('paragraph_suggestion', '‚úÖ ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'success'); 
                    return true; 
                } 
            }
            
            // v5.1 & v5.2: ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏ö
            function validatePageEnd() { 
                const startPageValue = dom.masterPageStartInput.value; 
                const endPageValue = dom.masterPageEndInput.value; 
            
                if (endPageValue === '') { 
                    return true; // ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏ö‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                } 
            
                const startPage = parseInt(startPageValue); 
                const endPage = parseInt(endPageValue); 
            
                if (isNaN(endPage) || endPage === 0 || (startPage && endPage < startPage)) {
                    alert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 0 ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°'); 
                    dom.masterPageEndInput.value = ''; // ‡∏ó‡∏≥‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á
                    dom.masterPageEndInput.focus(); 
                    return false; 
                } 
                return true; 
            }

            async function findLastGroupId() { 
                if(!dom.storyNameInput.value.trim()) return; 
                const statusElId = 'group_id_suggestion'; 
                updateStatus(statusElId, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...`, ''); 
                try { 
                    const q = query(paliCollection, where('sentence_group_id', '>=', `${currentPrefix}-`), where('sentence_group_id', '<', `${currentPrefix}-z`), orderBy('sentence_group_id', 'desc'), limit(1)); // Added orderBy
                    const querySnapshot = await getDocs(q); 
                    let lastNumber = 0; 
                    if (!querySnapshot.empty) { 
                        const fullId = querySnapshot.docs[0].data().sentence_group_id;
                        lastNumber = parseInt(fullId.toString().split('-').pop()) || 0;
                    } 
                    lastFoundGroupId = lastNumber; 
                    updateStatus(statusElId, `ID ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠: <strong><span class="math-inline">\{currentPrefix\}\-</span>{lastNumber}</strong>. ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ: <strong>${lastNumber + 1}</strong>`, 'success'); 
                } catch (error) { 
                    lastFoundGroupId = 0; 
                    if (error.code === 'failed-precondition') { 
                        updateStatus(statusElId, `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}. ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô`, 'error'); 
                    } else { 
                        updateStatus(statusElId, `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error'); 
                    } 
                } 
            }

            async function checkLastParagraph() { 
                const paraSuggestionEl = document.getElementById('paragraph_suggestion'); 
                if (!dom.storyNameInput.value.trim()) { 
                    paraSuggestionEl.textContent = ''; 
                    return; 
                } 
                paraSuggestionEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; 
                try { 
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("story_name", "==", dom.storyNameInput.value.trim()), orderBy("paragraph_num", "desc"), limit(1)); 
                    const querySnapshot = await getDocs(q); 
                    let lastParagraph = 0; 
                    if (!querySnapshot.empty) { 
                        lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0; 
                    } 
                    lastFoundParagraphNum = lastParagraph; 
                    updateStatus('paragraph_suggestion', `‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ ${lastParagraph}. ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ: ${lastParagraph + 1}`, 'success'); 
                } catch (error) { 
                    lastFoundParagraphNum = 0; 
                    if (error.code === 'failed-precondition') { 
                        updateStatus('paragraph_suggestion', '‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)', 'warning'); 
                    } else { 
                        updateStatus('paragraph_suggestion', '‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'success'); 
                    } 
                } 
            }

            async function checkPageExists() { 
                const pageNum = parseInt(dom.masterPageStartInput.value); 
                const resultEl = document.getElementById('page_check_result'); 
                if (!pageNum) { 
                    resultEl.innerHTML = ''; 
                    return; 
                } 
                resultEl.className = 'suggestion-text'; 
                resultEl.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ${pageNum}...`; 
                try { 
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("page_start", "==", pageNum), limit(5)); 
                    const querySnapshot = await getDocs(q); 
                    if (querySnapshot.empty) { 
                        updateStatus('page_check_result', `‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á`, 'success'); 
                    } else { 
                        let html = `‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!`; 
                        html += `<ul>`; 
                        querySnapshot.forEach(doc => { 
                            const data = doc.data(); 
                            html += `<li>Group ID: ${data.sentence_group_id}, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: ${data.pali_text.substring(0,30)}...</li>`; 
                        }); 
                        html += `</ul>`; 
                        updateStatus('page_check_result', html, 'warning'); 
                    } 
                } catch(error) { 
                    updateStatus('page_check_result', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message} (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index)`, 'error'); 
                } 
            }

            async function calculateHash(text) { 
                const encoder = new TextEncoder(); 
                const data = encoder.encode(text.trim()); 
                const hashBuffer = await crypto.subtle.digest('SHA-256', data); 
                const hashArray = Array.from(new Uint8Array(hashBuffer)); 
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); 
            }
            
            // v4.5: ‡∏õ‡∏∏‡πà‡∏° "‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á" (Clean and Format)
            function cleanAndFormat() {
                originalPaliText = dom.paliInput.value;
                let text = dom.paliInput.value;
                if (!text.trim()) return;

                // ‚úÖ ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≤‡∏ñ‡∏≤) - ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
                // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á ‚Ç¨ ‡πÄ‡∏õ‡πá‡∏ô ‡∏ê ‡πÅ‡∏•‡∏∞ ¬† ‡πÄ‡∏õ‡πá‡∏ô ‡∏ç (‡πÉ‡∏ä‡πâ space ‡∏Å‡πà‡∏≠‡∏ô ‡∏ç ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
                // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ ‡∏Ø ‡∏°‡∏µ 1 ‡πÄ‡∏Ñ‡∏≤‡∏∞ ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏á ‡∏Ø ‡∏°‡∏µ 2 ‡πÄ‡∏Ñ‡∏≤‡∏∞
                // ‚úÖ ‡∏°‡∏≠‡∏á ‡∏Ø‡πÄ‡∏õ‡∏Ø ‡πÅ‡∏•‡∏∞ ‡∏Ø‡∏•‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô 2 ‡πÄ‡∏Ñ‡∏≤‡∏∞
                const noisePatterns = [ 
                    /^=+.*/, /.*=+$/, /^\s*@.*/, /^\s*‡∏≠‡∏£‡∏£‡∏ñ‡∏Å‡∏ñ‡∏≤‡∏ö‡∏≤‡∏•‡∏µ.*/, 
                    /^\s*‡∏ß‡∏¥‡∏™‡∏∏‡∏ó‡∏∫‡∏ò‡∏¥‡∏°‡∏Ñ‡∏∫‡∏Ñ‡∏™‡∏∫‡∏™.*/, /^\s*‡∏™‡∏°‡∏ô‡∏∫‡∏ï‡∏õ‡∏≤‡∏™‡∏≤‡∏ó‡∏¥‡∏Å‡∏≤.*/, 
                    /^\s*‡∏ò‡∏°‡∏∫‡∏°‡∏õ‡∏ó‡∏è‡∏∫‡∏ê‡∏Å‡∏ñ‡∏≤.*/, /^\s*‡∏°‡∏á‡∏∫‡∏Ñ‡∏•‡∏ï‡∏∫‡∏ñ‡∏ó‡∏µ‡∏õ‡∏ô‡∏µ.*/, 
                    /^\s*‡∏≠‡∏†‡∏¥‡∏ò‡∏°‡∏∫‡∏°‡∏ï‡∏∫‡∏ñ‡∏™‡∏á‡∏∫‡∏Ñ‡∏´‡∏Ø.*/ 
                ];
                let lines = text.split(/\r?\n/);
                let cleanedLines = lines.filter(line => !noisePatterns.some(pattern => pattern.test(line.trim())));
                text = cleanedLines.join('\n'); // Preserve new lines for clean and format
                
                text = text.replace(/[‡πê-‡πô]+-/g, ''); // Remove numeric prefixes
                text = text.replace(/‚Ç¨/g, '‡∏ê').replace(/¬ê/g, '‡∏ç'); // Replace specific characters (Note: ¬† is not standard space)

                const pePlaceholder = " __PEYALA__ ";
                const etcPlaceholder = " __ETC__ ";
                text = text.replace(/‡∏Ø‡πÄ‡∏õ‡∏Ø/g, pePlaceholder).replace(/‡∏Ø‡∏•‡∏Ø/g, etcPlaceholder);

                lines = text.split(/\r?\n/);
                let formattedLines = lines.map(line => {
                    let tempLine = line.replace(/\s+/g, ' '); // Replace multiple spaces with single space
                    tempLine = tempLine.replace(/\s*‡∏Ø\s*/g, ' ‡∏Ø  '); // Ensure ' ‡∏Ø  ' (one space before, two spaces after)
                    // Replace single space with two spaces, but not before '‡∏Ø' or placeholders
                    tempLine = tempLine.replace(/ (?![‡∏Ø]|__PEYALA__|__ETC__)/g, '  '); // Two spaces for regular words

                    return tempLine;
                });
                text = formattedLines.join('\n');
                text = text.replace(new RegExp(pePlaceholder, 'g'), '‡∏Ø‡πÄ‡∏õ‡∏Ø').replace(new RegExp(etcPlaceholder, 'g'), '‡∏Ø‡∏•‡∏Ø'); // Restore placeholders

                dom.paliInput.value = text.trim();
                dom.cleanFormatBtn.style.display = 'none';
                dom.undoBtn.style.display = 'inline-block';
                checkFirstSentenceHash();
            }

            // v4.5: ‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î"
            function mergeLines() {
                originalPaliText = dom.paliInput.value;
                let text = dom.paliInput.value;
                if (!text.trim()) return;
                // ‚úÖ ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                // ‚úÖ ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞
                let singleLineText = text.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, ' ');
                dom.paliInput.value = singleLineText.trim();
                dom.mergeLinesBtn.style.display = 'none';
                dom.undoBtn.style.display = 'inline-block';
            }

            // v4.5: ‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
            function undoMerge() {
                dom.paliInput.value = originalPaliText;
                dom.mergeLinesBtn.style.display = 'inline-block';
                dom.cleanFormatBtn.style.display = 'inline-block';
                dom.undoBtn.style.display = 'none';
                checkFirstSentenceHash();
            }

            async function checkFirstSentenceHash() { 
                const content = dom.paliInput.value.trim(); 
                const resultEl = document.getElementById('hash_check_result'); 
                if (!content) { 
                    resultEl.innerHTML = ''; 
                    return; 
                } 
                const firstLine = content.split(/\r?\n/).find(line => line.trim() !== ''); 
                if (!firstLine) { 
                    resultEl.innerHTML = ''; 
                    return; 
                } 
                resultEl.className = 'suggestion-text'; 
                resultEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; 
                try { 
                    const contentHash = await calculateHash(firstLine); 
                    const q = query(paliCollection, where("first_sentence_hash", "==", contentHash), limit(1)); 
                    const querySnapshot = await getDocs(q); 
                    if (!querySnapshot.empty) { 
                        const docData = querySnapshot.docs[0].data(); 
                        updateStatus('hash_check_result', `‚ö†Ô∏è <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏≠‡∏≤‡∏à‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö Group ID: <strong>${docData.sentence_group_id}</strong>`, 'warning'); 
                    } else { 
                        updateStatus('hash_check_result', '‚úÖ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏ã‡πâ‡∏≥', 'success'); 
                    } 
                } catch(error) { 
                    updateStatus('hash_check_result', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message} (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index)`, 'error'); 
                } 
            }

            // v5.0: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß
            function addNewRow(tbody, id, paliText = '', docData = null, masterData = {}) { 
                const row = tbody.insertRow(); 
                row.className = 'draggable-row'; 
                row.draggable = true; 
                row.dataset.id = id; 
                const {masterGroupId, masterPageStart, masterPageEnd, masterParagraphNum} = masterData; 
                row.innerHTML = `
                    <td class="order-cell"><span class="math-inline">\{tbody\.rows\.length\}</td\>
<td class\="id\-cell"\></span>{id}</td>
                    <td><input type="number" class="group-id-input" value="<span class="math-inline">\{docData ? docData\.sentence\_group\_id\.split\('\-'\)\.pop\(\) \: masterGroupId\}"\></td\>
<td\><textarea class\="pali\-text\-input" rows\="3"\></span>{paliText}</textarea></td>
                    <td><input type="number" class="page-start-input" value="<span class="math-inline">\{docData ? docData\.page\_start \: masterPageStart\}"\></td\>
<td\><input type\="number" class\="page\-end\-input" value\="</span>{docData ? docData.page_end : masterPageEnd}"></td>
                    <td><input type="number" class="paragraph-num-input" value="${docData ? docData.paragraph_num : masterParagraphNum}"></td>
                    <td><select class="text-type-input">
                        <option value="‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ß" ${docData && docData.text_type === '‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ß' ? 'selected' : ''}>‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ß</option>
                        <option value="‡∏Ñ‡∏≤‡∏ñ‡∏≤" ${docData && docData.text_type === '‡∏Ñ‡∏≤‡∏ñ‡∏≤' ? 'selected' : ''}>‡∏Ñ‡∏≤‡∏ñ‡∏≤</option>
                    </select></td>
                    <td style="text-align:center;">
                        <button type="button" class="delete-row-btn" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ">üóëÔ∏è</button>
                    </td>`; 
                row.querySelector('.delete-row-btn').addEventListener('click', function() { 
                    if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { 
                        this.closest('tr').remove(); 
                        updateTableOrder(); 
                    } 
                }); 
            }

            function updateTableOrder() { 
                const tbody = dom.createSentenceTable.querySelector('tbody'); 
                if (tbody) { 
                    Array.from(tbody.rows).forEach((row, index) => { 
                        const orderCell = row.querySelector('.order-cell'); 
                        if (orderCell) { 
                            orderCell.textContent = index + 1; 
                        } 
                    }); 
                } 
            }

            // v5.0: ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á (Drag & Drop)
            function makeTableDraggable(tbody) { 
                let draggingRow = null; 
                tbody.addEventListener('dragstart', (e) => { 
                    draggingRow = e.target.closest('tr'); 
                    if (draggingRow) { 
                        setTimeout(() => draggingRow.classList.add('dragging'), 0); 
                    } 
                }); 
                tbody.addEventListener('dragend', (e) => { 
                    if (draggingRow) { 
                        draggingRow.classList.remove('dragging'); 
                        draggingRow = null; 
                        updateTableOrder(); // Update order after drag ends
                    } 
                }); 
                tbody.addEventListener('dragover', (e) => { 
                    e.preventDefault(); 
                    const targetRow = e.target.closest('tr'); 
                    if (targetRow && targetRow !== draggingRow && targetRow.tagName === 'TR') { // Ensure target is a row
                        const rect = targetRow.getBoundingClientRect(); 
                        const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5; 
                        tbody.insertBefore(draggingRow, next ? targetRow.nextSibling : targetRow); 
                    } 
                }); 
            }

            // v4.5: ‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ"
            async function generateCreateTable(dataToPopulate) { 
                if (!validateGroupId() || !validateParagraphNum()) { 
                    alert('Group ID ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥'); 
                    return; 
                } 
                if (!validatePageEnd()) return; 

                const masterGroupId = document.getElementById('master_group_id').value; 
                const masterPageStart = dom.masterPageStartInput.value; 
                const masterParagraphNum = document.getElementById('master_paragraph_num').value; 

                if (!dom.paliInput.value.trim() || !masterGroupId || !masterPageStart || !masterParagraphNum) { 
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô:\n- Group ID\n- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°\n- ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤\n- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏≤‡∏•‡∏µ'); 
                    return; 
                } 

                dom.createDataWorkArea.style.display = 'block'; 
                const table = dom.createSentenceTable; 
                table.innerHTML = createHeader; 
                const tbody = table.querySelector('tbody'); 

                try { 
                    const startId = dataToPopulate ? 0 : await findLastId("id"); 
                    nextAvailableId = startId + 1; 
                    
                    const masterData = { 
                        masterGroupId, 
                        masterPageStart, 
                        masterPageEnd: document.getElementById('master_page_end').value, 
                        masterParagraphNum 
                    }; 

                    const sourceContent = dataToPopulate ? dataToPopulate.map(d => d.pali_text).join('\n') : dom.paliInput.value; 
                    const pePlaceholder = "__PEYALA_PLACEHOLDER__"; 
                    const etcPlaceholder = "__ETC_PLACEHOLDER__"; 
                    
                    // ‡∏°‡∏≠‡∏á ‡∏Ø‡πÄ‡∏õ‡∏Ø ‡πÅ‡∏•‡∏∞ ‡∏Ø‡∏•‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á
                    let tempContent = sourceContent.replace(/‡∏Ø‡πÄ‡∏õ‡∏Ø/g, pePlaceholder).replace(/‡∏Ø‡∏•‡∏Ø/g, etcPlaceholder); 
                    
                    let lines = tempContent.split(/\r?\n/); // ‚úÖ ‡πÅ‡∏ö‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (Enter) ‡∏Å‡πà‡∏≠‡∏ô
                    let finalSentences = []; 

                    lines.forEach(line => { 
                        if (line.trim() === '') return; 
                        const parts = line.split('‡∏Ø'); // ‚úÖ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ø
                        for (let i = 0; i < parts.length; i++) { 
                            let sentence = parts[i].trim(); 
                            if (sentence.length > 0) { 
                                if (i < parts.length - 1) { 
                                    sentence += ' ‡∏Ø'; // ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏Ø ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                                } 
                                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ ‡∏Ø‡πÄ‡∏õ‡∏Ø ‡πÅ‡∏•‡∏∞ ‡∏Ø‡∏•‡∏Ø
                                let displaySentence = sentence.replace(new RegExp(pePlaceholder, 'g'), '‡∏Ø‡πÄ‡∏õ‡∏Ø').replace(new RegExp(etcPlaceholder, 'g'), '‡∏Ø‡∏•‡∏Ø'); 
                                finalSentences.push(displaySentence.trim()); 
                            } 
                        } 
                    }); 
                    
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ø ‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    if (finalSentences.length === 0 && sourceContent.trim().length > 0) { 
                        finalSentences.push(sourceContent.trim().replace(new RegExp(pePlaceholder, 'g'), '‡∏Ø‡πÄ‡∏õ‡∏Ø').replace(new RegExp(etcPlaceholder, 'g'), '‡∏Ø‡∏•‡∏Ø')); 
                    } 

                    finalSentences.forEach((sentence, index) => { 
                        const docData = dataToPopulate ? dataToPopulate[index] : null; 
                        const newId = docData ? docData.id : nextAvailableId++; 
                        addNewRow(tbody, newId, sentence, docData, masterData); 
                    }); 
                    makeTableDraggable(tbody); 
                    if (finalSentences.length > 0) { 
                        dom.createSaveBtn.disabled = false; 
                    } 
                } catch (error) { 
                    updateStatus('create-status-message', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error'); 
                } 
            }

            async function saveData() { 
                const statusElId = 'create-status-message'; 
                if (!dom.userNameInput.value.trim()) { 
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); 
                    return; 
                } 
                updateStatus(statusElId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', ''); 
                dom.createSaveBtn.disabled = true; 
                try { 
                    const batch = writeBatch(db); 
                    const chapterName = document.getElementById('chapter_name').value;
                    const storyName = dom.storyNameInput.value;
                    const sectionName = document.getElementById('section_name').value; 
                    const displayFlag = parseInt(document.getElementById('display_flag').value); 
                    
                    const firstLine = dom.paliInput.value.trim().split(/\r?\n/).find(line => line.trim() !== '') || ''; 
                    const firstSentenceHash = firstLine ? await calculateHash(firstLine) : null; 

                    Array.from(dom.createSentenceTable.querySelector('tbody').rows).forEach((row, index) => { 
                        const docId = row.dataset.id; 
                        const groupIdNum = row.querySelector('.group-id-input')?.value || '0'; 
                        const fullGroupId = `<span class="math-inline">\{currentPrefix\}\-</span>{groupIdNum}`; 
                        const docRef = doc(db, "pali_sentences", docId); 
                        let dataToSave = { 
                            id: parseInt(docId), 
                            sentence_group_id: fullGroupId, 
                            pali_order: parseInt(row.cells[0].textContent) || (index + 1), 
                            book_title: currentBookName, 
                            book_part: currentBookPart, 
                            chapter_name: chapterName, 
                            story_name: storyName, 
                            section_name: sectionName, 
                            display_flag: displayFlag, 
                            page_start: parseInt(row.querySelector('.page-start-input')?.value) || 0, 
                            page_end: parseInt(row.querySelector('.page-end-input')?.value) || 0, 
                            paragraph_num: parseInt(row.querySelector('.paragraph-num-input')?.value) || 0, 
                            text_type: row.querySelector('.text-type-input')?.value, 
                            pali_text: row.querySelector('.pali-text-input')?.value.trim(), 
                            user_name_pali: dom.userNameInput.value.trim(), 
                            timestamp_pali: serverTimestamp(), 
                            first_sentence_hash: (index === 0 ? firstSentenceHash : null) 
                        }; 
                        if (currentMode === 'create') { 
                            Object.assign(dataToSave, { thai_text: "", thai_order: 0, user_name_thai: "", timestamp_thai: null, translation_status: 'untranslated' }); 
                        } 
                        batch.set(docRef, dataToSave, { merge: true }); 
                    }); 
                    await batch.commit(); 
                    updateStatus(statusElId, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤...', 'success'); 
                    setTimeout(() => { 
                        if(currentMode === 'super-edit') { 
                            const params = new URLSearchParams({ bookName: currentBookName, bookPart: currentBookPart, prefix: currentPrefix }); 
                            window.location.href = `translate.html?${params.toString()}`; 
                        } else { 
                            window.location.reload(); 
                        } 
                    }, 1500); 
                } catch (error) { 
                    updateStatus(statusElId, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error'); 
                    dom.createSaveBtn.disabled = false; 
                } 
            }

            async function fetchDataForFullEdit(groupId) { 
                updateStatus('create-status-message', `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Group ID: ${groupId} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...`, 'loading'); 
                try { 
                    const q = query(paliCollection, where("sentence_group_id", "==", groupId), orderBy("pali_order")); 
                    const querySnapshot = await getDocs(q); 
                    const data = querySnapshot.docs.map(doc => doc.data()); 
                    if (data.length > 0) { 
                        populateCreateFormWithData(data); 
                    } else { 
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); 
                    } 
                } catch (error) { 
                    updateStatus('create-status-message', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error'); 
                } 
            }

            function populateCreateFormWithData(data) { 
                currentMode = 'super-edit'; 
                document.getElementById('create-view-header').textContent = `‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Group: ${data[0].sentence_group_id})`; 
                dom.createSaveBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å'; 
                const firstDoc = data[0]; 
                document.getElementById('chapter_name').value = firstDoc.chapter_name || ''; 
                dom.storyNameInput.value = firstDoc.story_name || ''; 
                document.getElementById('section_name').value = firstDoc.section_name || ''; 
                document.getElementById('display_flag').value = firstDoc.display_flag || '2'; 
                dom.masterGroupIdInput.value = firstDoc.sentence_group_id.split('-').pop() || ''; 
                dom.masterPageStartInput.value = firstDoc.page_start || ''; 
                dom.masterPageEndInput.value = firstDoc.page_end || ''; 
                dom.masterParagraphNumInput.value = firstDoc.paragraph_num || ''; 
                dom.paliInput.value = data.map(d => d.pali_text).join('\n'); 
                generateCreateTable(data); 
            }

            async function populateCreateDatalists() { 
                try { 
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart)); 
                    const querySnapshot = await getDocs(q); 
                    const chapters = new Set(), stories = new Set(), sections = new Set(); 
                    querySnapshot.forEach(doc => { 
                        const data = doc.data(); 
                        if (data.chapter_name) chapters.add(data.chapter_name); 
                        if (data.story_name) stories.add(data.story_name); 
                        if (data.section_name) sections.add(data.section_name); 
                    }); 
                    fillDatalist('chapter_datalist', chapters); 
                    fillDatalist('story_datalist', stories); 
                    fillDatalist('section_datalist', sections); 
                } catch (error) { 
                    console.error("Could not populate create-view datalists:", error); 
                } 
            }

            function fillDatalist(datalistId, dataSet) { 
                const datalistElement = document.getElementById(datalistId); 
                if (datalistElement) { 
                    datalistElement.innerHTML = ''; 
                    Array.from(dataSet).sort().forEach(item => { 
                        const option = document.createElement('option'); 
                        option.value = item; 
                        datalistElement.appendChild(option); 
                    }); 
                } 
            }
            
            function initializeTool() {
                const params = new URLSearchParams(window.location.search);
                currentBookName = decodeURIComponent(params.get('bookName') || '');
                currentBookPart = decodeURIComponent(params.get('bookPart') || '');
                currentPrefix = decodeURIComponent(params.get('prefix') || '');
                const editGroupId = decodeURIComponent(params.get('editGroupId') || '');
                if (!currentBookName || !currentPrefix) {
                    dom.mainHeader.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                    dom.container.innerHTML = `<div class="header-bar"><h1>‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h1></div><p style="text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠ Prefix ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</p><br><p style="text-align:center;"><a href="index.html"><button class="secondary">‡∏Å‡∏•‡∏±‡∏ö</button></a></p>`;
                    return;
                }
                dom.mainHeader.textContent = `${currentBookName}`;
                dom.subHeader.textContent = currentBookPart;
                const savedUserName = localStorage.getItem('paliToolUserName');
                if (savedUserName) { dom.userNameInput.value = savedUserName; }
                dom.userNameInput.addEventListener('input', () => { localStorage.setItem('paliToolUserName', dom.userNameInput.value); });
                populateCreateDatalists();
                if (editGroupId) {
                    fetchDataForFullEdit(editGroupId);
                }
            }
            
            // Event Listeners
            dom.storyNameInput.addEventListener('blur', async () => { await checkLastParagraph(); await findLastGroupId(); });
            dom.masterPageStartInput.addEventListener('blur', checkPageExists);
            dom.masterPageEndInput.addEventListener('blur', validatePageEnd); // Add listener for validatePageEnd
            dom.masterGroupIdInput.addEventListener('input', validateGroupId); // Add input listener for real-time validation
            dom.masterParagraphNumInput.addEventListener('input', validateParagraphNum); // Add input listener for real-time validation

            dom.paliInput.addEventListener('blur', checkFirstSentenceHash);
            dom.cleanFormatBtn.addEventListener('click', cleanAndFormat); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            dom.mergeLinesBtn.addEventListener('click', mergeLines);
            dom.undoBtn.addEventListener('click', undoMerge); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

            dom.splitBtn.addEventListener('click', () => generateCreateTable(null)); // ‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ"

            // v5.0: ‡∏õ‡∏∏‡πà‡∏° "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á"
            dom.addRowBtn.addEventListener('click', () => {
                const tbody = dom.createSentenceTable.querySelector('tbody');
                const lastRow = tbody.lastElementChild;
                let masterData = { masterGroupId: '', masterPageStart: '', masterPageEnd: '', masterParagraphNum: '' };

                // Try to get values from the last row if it exists
                if (lastRow) {
                    masterData.masterGroupId = lastRow.querySelector('.group-id-input')?.value || '';
                    masterData.masterPageStart = lastRow.querySelector('.page-start-input')?.value || '';
                    masterData.masterPageEnd = lastRow.querySelector('.page-end-input')?.value || '';
                    masterData.masterParagraphNum = lastRow.querySelector('.paragraph-num-input')?.value || '';
                } else {
                    // Fallback to master inputs if no rows exist
                    masterData.masterGroupId = dom.masterGroupIdInput.value;
                    masterData.masterPageStart = dom.masterPageStartInput.value;
                    masterData.masterPageEnd = dom.masterPageEndInput.value;
                    masterData.masterParagraphNum = dom.masterParagraphNumInput.value;
                }
                
                // Increment paragraph_num if there's a last row and it's not in super-edit mode
                if (currentMode !== 'super-edit' && lastRow) {
                    masterData.masterParagraphNum = parseInt(masterData.masterParagraphNum) +