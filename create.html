<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้าง/แก้ไขข้อมูลหลัก (v5.9.11 - Final)</title>
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        h1, h2 { color: var(--text-dark); margin-top: 0; }
        h1 { border: none; padding: 0; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: var(--text-light); padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: start;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: var(--primary-color); color: var(--white-bg); padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { filter: brightness(90%); }
        button.secondary { background-color: var(--secondary-color); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .status-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; word-break: break-word; min-height: 1.5em;}
        .status-message.success, .suggestion-text.success { color: #155724; background-color: #d4edda; padding: 10px; border-radius: 4px;}
        .status-message.error, .suggestion-text.error { color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px;}
        .suggestion-text { font-size: 0.9em; color: var(--text-light); margin-top: 5px; min-height: 1.2em; }
        .suggestion-text.warning { color: var(--warning-color); font-weight: bold; }
        .suggestion-text ul { margin: 5px 0 0 20px; padding: 0; list-style-type: '⚠️'; }
        .table-wrapper { margin-top: 20px; overflow-x: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background-color: #ecf0f1; position: sticky; top: 0; z-index: 1; text-align: center; }
        #create-sentence-table { min-width: 1200px; }
        #create-sentence-table th:nth-child(1), #create-sentence-table td:nth-child(1) { width: 50px; text-align: center; }
        #create-sentence-table th:nth-child(2), #create-sentence-table td:nth-child(2) { width: 60px; text-align: center; }
        #create-sentence-table th:nth-child(3), #create-sentence-table td:nth-child(3) { width: 80px; }
        #create-sentence-table th:nth-child(4) { width: 55%; }
        #create-sentence-table td input, #create-sentence-table td select, #create-sentence-table td textarea { width: 95%; box-sizing: border-box;}
        .delete-row-btn, .split-row-btn { cursor: pointer; font-weight: bold; font-size: 1.2em; border: none; background: none; padding: 0 5px; }
        .delete-row-btn { color: var(--danger-color); }
        .split-row-btn { color: var(--primary-color); }
        .draggable-row { cursor: move; }
        .dragging { background-color: #f0f8ff; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="header-bar">
            <div><h1 id="main-header">กำลังโหลด...</h1><p id="sub-header"></p></div>
            <a href="index.html"><button class="secondary">กลับไปหน้าสารบัญ</button></a>
        </div>
        <div id="create-view">
            <h2 id="create-view-header">หน้าเครื่องมือ (สร้างข้อมูลบาลี)</h2>
            <fieldset> <legend>ข้อมูลผู้ใช้งาน</legend> <input type="text" id="user_name" placeholder="ใส่ชื่อของคุณที่นี่" required> </fieldset>
            <fieldset><legend>ข้อมูลกำกับ</legend><div class="form-grid">
                <input type="text" id="chapter_name" placeholder="วรรค/บท" list="chapter_datalist"><datalist id="chapter_datalist"></datalist>
                <input type="text" id="story_name" placeholder="ชื่อเรื่อง" list="story_datalist"><datalist id="story_datalist"></datalist>
                <input type="text" id="section_name" placeholder="ชื่อตอน" list="section_datalist"><datalist id="section_datalist"></datalist>
                <select id="display_flag" required> <option value="2" selected>2 - พร้อมใช้</option> <option value="1">1 - รอตรวจ</option> <option value="0">0 - ร่าง</option> </select>
            </div></fieldset>
            <fieldset><legend>ข้อมูล Group ID, หน้า, และย่อหน้า (ต้องกรอก*)</legend><div class="form-grid">
                <div> <label for="master_group_id">Group ID (ตัวเลขเท่านั้น)*</label> <input type="number" id="master_group_id" placeholder="ใส่ ID เริ่มต้น"> <p id="group_id_suggestion" class="suggestion-text"></p></div>
                <div> <label for="master_page_start">หน้าเริ่ม*</label> <input type="number" id="master_page_start"> <p id="page_check_result" class="suggestion-text"></p> </div>
                <div> <label for="master_page_end">หน้าจบ</label> <input type="number" id="master_page_end"> </div>
                <div> <label for="master_paragraph_num">ย่อหน้า*</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div>
            </div></fieldset>
            <fieldset><legend>วางเนื้อหาบาลี</legend>
                <textarea id="pali-input" rows="8"></textarea>
                <p id="hash_check_result" class="suggestion-text"></p>
                <div style="margin-top:10px; display:flex; gap: 10px; flex-wrap: wrap;">
                    <button id="copy-pali-btn" class="secondary">คัดลอกเนื้อหา</button>
                    <button id="clean-format-btn" class="secondary">ทำความสะอาด & จัดระเบียบ</button>
                    <button id="merge-lines-btn" class="secondary">รวมบรรทัดอย่างเดียว</button>
                    <button id="undo-btn" class="secondary" style="display: none;">ยกเลิก</button>
                    <button id="split-btn">กดเพื่อแบ่งประโยค</button>
                </div>
            </fieldset>
            <div id="create-data-work-area" style="display: none;">
                <fieldset><legend>ตารางสร้างข้อมูล</legend>
                    <div class="table-wrapper"><table id="create-sentence-table" style="width:100%"></table></div>
                    <button id="add-row-btn" class="secondary" style="margin-top: 10px;">+ เพิ่มแถวว่าง</button>
                </fieldset>
                <fieldset><legend>บันทึกข้อมูล</legend><button id="create-save-btn" disabled>บันทึกข้อมูล</button><div id="create-status-message" class="status-message"></div></fieldset>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDoe7sUNTdaK7uFxvi_Y16C4nCX4kKFiDA",
            authDomain: "pali-exam-builder.firebaseapp.com",
            projectId: "pali-exam-builder",
            storageBucket: "pali-exam-builder.appspot.com",
            messagingSenderId: "783124881115",
            appId: "1:783124881115:web:688f964e586df5b17d36fe",
            measurementId: "G-8HV8B03THV"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '', currentPrefix = '';
        let currentMode = 'create';
        let originalPaliText = ''; 
        let nextAvailableId = 1;
        let lastFoundGroupId = 0;
        let lastFoundParagraphNum = 0;

        document.addEventListener('DOMContentLoaded', () => {
            const createHeader = `<thead><tr><th>ลำดับ</th><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th><th>จัดการ</th></tr></thead><tbody></tbody>`;
            const dom = {
                container: document.getElementById('container'), mainHeader: document.getElementById('main-header'), subHeader: document.getElementById('sub-header'),
                userNameInput: document.getElementById('user_name'), storyNameInput: document.getElementById('story_name'),
                chapter_name: document.getElementById('chapter_name'), section_name: document.getElementById('section_name'), display_flag: document.getElementById('display_flag'),
                masterPageStartInput: document.getElementById('master_page_start'), masterPageEndInput: document.getElementById('master_page_end'),
                paliInput: document.getElementById('pali-input'), masterGroupIdInput: document.getElementById('master_group_id'),
                masterParagraphNumInput: document.getElementById('master_paragraph_num'),
                createSaveBtn: document.getElementById('create-save-btn'),
                cleanFormatBtn: document.getElementById('clean-format-btn'),
                mergeLinesBtn: document.getElementById('merge-lines-btn'),
                copyPaliBtn: document.getElementById('copy-pali-btn'),
                undoBtn: document.getElementById('undo-btn'),
                splitBtn: document.getElementById('split-btn'), createDataWorkArea: document.getElementById('create-data-work-area'),
                createSentenceTable: document.getElementById('create-sentence-table'),
                addRowBtn: document.getElementById('add-row-btn'),
            };

            function handleFirestoreError(error, elementId, defaultMessage = 'เกิดข้อผิดพลาด') {
                let errorMessage = error.message;
                if (error.code === 'unavailable' || !navigator.onLine) { errorMessage = 'ไม่สามารถเชื่อมต่ออินเทอร์เน็ตได้'; } 
                else if (error.code === 'failed-precondition') { errorMessage = `${defaultMessage}: ${error.message} (อาจต้องสร้าง Index)`; }
                updateStatus(elementId, `❌ ${errorMessage}`, 'error');
                console.error(`Firestore Error on element ${elementId}:`, error);
            }

            function updateStatus(elementId, message, type) { 
                const el = document.getElementById(elementId); 
                if(el){ el.innerHTML = message; el.className = `suggestion-text ${type}`; if(elementId.includes('status')) el.className = `status-message ${type}`; } 
            }

            async function findLastId(field) { 
                const q = query(paliCollection, orderBy(field, "desc"), limit(1)); 
                const querySnapshot = await getDocs(q); 
                if (querySnapshot.empty) return 0; 
                return querySnapshot.docs[0].data()[field] || 0; 
            }
            
            function validateGroupId() { 
                const currentId = parseInt(dom.masterGroupIdInput.value); 
                if (currentMode === 'super-edit') { updateStatus('group_id_suggestion', 'อยู่ในโหมดแก้ไขข้อมูลหลัก', ''); return true; } 
                if (isNaN(currentId) || !currentId) { updateStatus('group_id_suggestion', 'กรุณากรอก Group ID (ตัวเลขเท่านั้น)', 'error'); return false; }
                if (currentId <= lastFoundGroupId) { updateStatus('group_id_suggestion', `❌ ไม่สามารถใช้ ID ที่น้อยกว่าหรือเท่ากับ ID สูงสุดได้ (สูงสุดคือ ${lastFoundGroupId})`, 'error'); return false; } 
                else if (currentId > lastFoundGroupId + 1) { updateStatus('group_id_suggestion', `❌ ไม่สามารถข้ามลำดับ ID ได้ (ต้องใช้ ${lastFoundGroupId + 1})`, 'error'); return false; } 
                else { updateStatus('group_id_suggestion', '✅ ID ถูกต้อง', 'success'); return true; } 
            }

            function validateParagraphNum() { 
                const currentNum = parseInt(dom.masterParagraphNumInput.value); 
                if (currentMode === 'super-edit') { updateStatus('paragraph_suggestion', 'อยู่ในโหมดแก้ไขข้อมูลหลัก', ''); return true; } 
                if (isNaN(currentNum) || !currentNum) { updateStatus('paragraph_suggestion', 'กรุณากรอกเลขย่อหน้า (ตัวเลขเท่านั้น)', 'error'); return false;}
                if (currentNum < lastFoundParagraphNum) { updateStatus('paragraph_suggestion', `❌ ไม่สามารถใช้ย่อหน้าที่น้อยกว่าย่อหน้าล่าสุดได้ (ล่าสุดคือ ${lastFoundParagraphNum})`, 'error'); return false; } 
                else if (currentNum > lastFoundParagraphNum + 1) { updateStatus('paragraph_suggestion', `❌ ไม่สามารถข้ามลำดับย่อหน้าได้ (ต้องใช้ ${lastFoundParagraphNum} หรือ ${lastFoundParagraphNum + 1})`, 'error'); return false; } 
                else { updateStatus('paragraph_suggestion', '✅ ย่อหน้าถูกต้อง', 'success'); return true; } 
            }
            
            function validatePageEnd() { 
                const startPageValue = dom.masterPageStartInput.value; 
                const endPageValue = dom.masterPageEndInput.value; 
                if (endPageValue === '') return true; 
                const startPage = parseInt(startPageValue); 
                const endPage = parseInt(endPageValue); 
                if (isNaN(endPage) || endPage === 0 || (startPage && endPage < startPage)) {
                    alert('ข้อผิดพลาด: เลขหน้าจบต้องไม่ใช่ 0 และต้องไม่น้อยกว่าเลขหน้าเริ่ม'); 
                    dom.masterPageEndInput.value = ''; dom.masterPageEndInput.focus(); return false; 
                } 
                return true; 
            }

            async function findLastGroupId() { 
                if (!currentBookName || !currentPrefix) return; 
                const statusElId = 'group_id_suggestion'; 
                updateStatus(statusElId, `กำลังค้นหา ID สูงสุดของคัมภีร์...`, ''); 
                try { 
                    const q = query(paliCollection, where('sentence_group_id', '>=', `${currentPrefix}-`), where('sentence_group_id', '<', `${currentPrefix}-z`));
                    const querySnapshot = await getDocs(q); 
                    let maxNumber = 0; 
                    if (!querySnapshot.empty) { 
                        const allNumbers = querySnapshot.docs.map(doc => parseInt(doc.data().sentence_group_id.toString().split('-').pop()) || 0);
                        maxNumber = Math.max(...allNumbers);
                    } 
                    lastFoundGroupId = maxNumber;
                    updateStatus(statusElId, `ID <strong>สูงสุด</strong>ที่ใช้ในคัมภีร์นี้คือ: <strong>${currentPrefix}-${lastFoundGroupId}</strong>. แนะนำให้ใช้: <strong>${lastFoundGroupId + 1}</strong>`, 'success'); 
                } catch (error) {
                    if (error.code !== 'unavailable' && navigator.onLine) { lastFoundGroupId = 0; }
                    handleFirestoreError(error, statusElId, 'ไม่สามารถค้นหา Group ID ได้');
                }
            }

            async function checkLastParagraph() { 
                const paraSuggestionEl = document.getElementById('paragraph_suggestion'); 
                if (!dom.storyNameInput.value.trim()) { paraSuggestionEl.textContent = ''; return; } 
                paraSuggestionEl.textContent = 'กำลังตรวจสอบ...'; 
                try { 
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("story_name", "==", dom.storyNameInput.value.trim()), orderBy("paragraph_num", "desc"), limit(1)); 
                    const querySnapshot = await getDocs(q); 
                    let lastParagraph = 0; 
                    if (!querySnapshot.empty) { lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0; } 
                    lastFoundParagraphNum = lastParagraph; 
                    updateStatus('paragraph_suggestion', `เรื่องนี้มีย่อหน้าล่าสุดคือ ${lastParagraph}. แนะนำให้ใช้: ${lastParagraph + 1}`, 'success'); 
                } catch (error) {
                    if (error.code !== 'unavailable' && navigator.onLine) { lastFoundParagraphNum = 0; }
                    handleFirestoreError(error, 'paragraph_suggestion', 'เป็นเรื่องใหม่');
                }
            }

            async function checkPageExists() { 
                const pageNum = parseInt(dom.masterPageStartInput.value); 
                const resultEl = document.getElementById('page_check_result'); 
                if (!pageNum) { resultEl.innerHTML = ''; return; } 
                resultEl.className = 'suggestion-text'; 
                resultEl.textContent = `กำลังตรวจสอบหน้า ${pageNum}...`; 
                try { 
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("page_start", "==", pageNum), limit(5)); 
                    const querySnapshot = await getDocs(q); 
                    if (querySnapshot.empty) { 
                        updateStatus('page_check_result', `✅ หน้านี้ยังว่าง`, 'success'); 
                    } else { 
                        let html = `⚠️ หน้านี้มีข้อมูลแล้ว!`; 
                        html += `<ul>`; 
                        querySnapshot.forEach(doc => { const data = doc.data(); html += `<li>Group ID: ${data.sentence_group_id}, เนื้อหา: ${data.pali_text.substring(0,30)}...</li>`; }); 
                        html += `</ul>`; 
                        updateStatus('page_check_result', html, 'warning'); 
                    } 
                } catch(error) { handleFirestoreError(error, 'page_check_result', 'เกิดข้อผิดพลาดในการตรวจสอบหน้า'); } 
            }

            async function calculateHash(text) { 
                const encoder = new TextEncoder(); 
                const data = encoder.encode(text.trim()); 
                const hashBuffer = await crypto.subtle.digest('SHA-256', data); 
                const hashArray = Array.from(new Uint8Array(hashBuffer)); 
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); 
            }
            
            function cleanAndFormat() {
                originalPaliText = dom.paliInput.value;
                let text = dom.paliInput.value;
                if (!text.trim()) return;
                const hyphenatedWordRegex = /([a-zA-Zเ-ไก-ฮฯ-์])-\s*\n\s*\*?\s*([a-zA-Zเ-ไก-ฮฯ-์])/g;
                text = text.replace(hyphenatedWordRegex, '$1$2');
                const noisePatterns = [ /^=+.*/, /.*=+$/, /^\s*@.*/, /^\s*อรรถกถาบาลี.*/, /^\s*คัมภีร์สำคัญอื่นๆ.*/  ];
                let lines = text.split(/\r?\n/);
                let cleanedLines = lines.filter(line => !noisePatterns.some(pattern => pattern.test(line.trim())));
                text = cleanedLines.join('\n');
                text = text.replace(/[๐-๙]+-/g, '');
                text = text.replace(/€/g, 'ฐ').replace(//g, 'ญ');
                const pePlaceholder = " __PEYALA__ ", etcPlaceholder = " __ETC__ ";
                text = text.replace(/ฯเปฯ/g, pePlaceholder).replace(/ฯลฯ/g, etcPlaceholder);
                text = text.replace(/\s*\|\s*/g, '  |  ');
                lines = text.split(/\r?\n/);
                let formattedLines = lines.map(line => {
                    let tempLine = line.replace(/\s+/g, ' ');
                    tempLine = tempLine.replace(/\s*ฯ\s*/g, ' ฯ  ');
                    tempLine = tempLine.replace(/ (?![ฯ]|__PEYALA__|__ETC__)/g, '  ');
                    return tempLine;
                });
                text = formattedLines.join('\n');
                text = text.replace(new RegExp(pePlaceholder, 'g'), 'ฯเปฯ').replace(new RegExp(etcPlaceholder, 'g'), 'ฯลฯ');
                dom.paliInput.value = text.trim();
                dom.cleanFormatBtn.style.display = 'none';
                dom.undoBtn.style.display = 'inline-block';
                checkFirstSentenceHash();
            }

            function mergeLines() {
                originalPaliText = dom.paliInput.value;
                let text = dom.paliInput.value;
                if (!text.trim()) return;
                const hyphenatedWordRegex = /([a-zA-Zเ-ไก-ฮฯ-์])-\s*(\r\n|\n|\r)\s*\*?\s*([a-zA-Zเ-ไก-ฮฯ-์])/g;
                text = text.replace(hyphenatedWordRegex, '$1$3');
                let singleLineText = text.replace(/(\r\n|\n|\r)/gm, "  ");
                singleLineText = singleLineText.replace(/\s{3,}/g, '  ');
                dom.paliInput.value = singleLineText.trim();
                dom.mergeLinesBtn.style.display = 'none';
                dom.undoBtn.style.display = 'inline-block';
            }

            function undoMerge() {
                dom.paliInput.value = originalPaliText;
                dom.mergeLinesBtn.style.display = 'inline-block';
                dom.cleanFormatBtn.style.display = 'inline-block';
                dom.undoBtn.style.display = 'none';
            }

            async function checkFirstSentenceHash() { 
                const content = dom.paliInput.value.trim(); 
                const resultEl = document.getElementById('hash_check_result'); 
                if (!content) { resultEl.innerHTML = ''; return; } 
                const firstLine = content.split(/\r?\n/).find(line => line.trim() !== ''); 
                if (!firstLine) { resultEl.innerHTML = ''; return; } 
                resultEl.className = 'suggestion-text'; resultEl.textContent = 'กำลังตรวจสอบ...'; 
                try { 
                    const contentHash = await calculateHash(firstLine); 
                    const q = query(paliCollection, where("first_sentence_hash", "==", contentHash), limit(1)); 
                    const querySnapshot = await getDocs(q); 
                    if (!querySnapshot.empty) { 
                        const docData = querySnapshot.docs[0].data(); 
                        updateStatus('hash_check_result', `⚠️ <strong>คำเตือน:</strong> อาจซ้ำกับ Group ID: <strong>${docData.sentence_group_id}</strong>`, 'warning'); 
                    } else { 
                        updateStatus('hash_check_result', '✅ เนื้อหานี้ไม่น่าจะซ้ำ', 'success'); 
                    } 
                } catch(error) { handleFirestoreError(error, 'hash_check_result', 'เกิดข้อผิดพลาดในการตรวจสอบเนื้อหา'); } 
            }
            
            function handleSplitRow(event) {
                const splitButton = event.currentTarget;
                const currentRow = splitButton.closest('tr');
                const tbody = currentRow.closest('tbody');
                const paliTextarea = currentRow.querySelector('.pali-text-input');
                const cursorPos = paliTextarea.selectionStart;
                const fullText = paliTextarea.value;
                if (cursorPos === 0 || cursorPos === fullText.length) { alert('กรุณาวางเคอร์เซอร์ในตำแหน่งที่ต้องการแบ่ง (ไม่ใช่จุดเริ่มต้นหรือท้ายสุด)'); return; }
                const textBefore = fullText.substring(0, cursorPos).trim();
                const textAfter = fullText.substring(cursorPos).trim();
                if (!textAfter) { alert('ไม่มีข้อความเหลือให้แบ่ง'); return; }
                paliTextarea.value = textBefore;
                const masterData = {
                    masterGroupId: parseInt(currentRow.querySelector('.group-id-input').value),
                    masterPageStart: currentRow.querySelector('.page-start-input').value,
                    masterPageEnd: currentRow.querySelector('.page-end-input').value,
                    masterParagraphNum: currentRow.querySelector('.paragraph-num-input').value
                };
                const newRow = addNewRow(tbody, nextAvailableId++, textAfter, null, masterData, true);
                currentRow.after(newRow);
                updateTableOrder();
            }
            
            function addNewRow(tbody, id, paliText = '', docData = null, masterData = {}, isSplit = false) { 
                const row = tbody.insertRow(isSplit ? -1 : undefined); 
                row.className = 'draggable-row'; row.draggable = true; row.dataset.id = id; 
                const {masterGroupId, masterPageStart, masterPageEnd, masterParagraphNum} = masterData; 
                row.innerHTML = `
                    <td class="order-cell">${tbody.rows.length}</td><td class="id-cell">${id}</td>
                    <td><input type="number" class="group-id-input" value="${docData ? docData.sentence_group_id.split('-').pop() : masterGroupId}"></td>
                    <td><textarea class="pali-text-input" rows="3">${paliText}</textarea></td>
                    <td><input type="number" class="page-start-input" value="${docData ? docData.page_start : masterPageStart}"></td>
                    <td><input type="number" class="page-end-input" value="${docData ? docData.page_end : masterPageEnd}"></td>
                    <td><input type="number" class="paragraph-num-input" value="${docData ? docData.paragraph_num : masterParagraphNum}"></td>
                    <td><select class="text-type-input"><option value="ร้อยแก้ว" ${docData && docData.text_type === 'ร้อยแก้ว' ? 'selected' : ''}>ร้อยแก้ว</option><option value="คาถา 1 บาท" ${docData && docData.text_type === 'คาถา 1 บาท' ? 'selected' : ''}>คาถา 1 บาท</option><option value="คาถา 2 บาท" ${docData && docData.text_type === 'คาถา 2 บาท' ? 'selected' : ''}>คาถา 2 บาท</option></select></td>
                    <td style="text-align:center;"><button type="button" class="split-row-btn" title="แบ่งประโยคที่ตำแหน่งเคอร์เซอร์">✂️</button><button type="button" class="delete-row-btn" title="ลบแถวนี้">🗑️</button></td>`; 
                row.querySelector('.split-row-btn').addEventListener('click', handleSplitRow);
                row.querySelector('.delete-row-btn').addEventListener('click', function() { if (confirm('คุณต้องการลบแถวนี้ใช่หรือไม่?')) { this.closest('tr').remove(); updateTableOrder(); } }); 
                return row;
            }

            function updateTableOrder() { 
                const tbody = dom.createSentenceTable.querySelector('tbody'); 
                if (tbody) { Array.from(tbody.rows).forEach((row, index) => { const orderCell = row.querySelector('.order-cell'); if (orderCell) { orderCell.textContent = index + 1; } }); } 
            }

            function makeTableDraggable(tbody) { 
                let draggingRow = null; 
                tbody.addEventListener('dragstart', (e) => { draggingRow = e.target.closest('tr'); if (draggingRow) { setTimeout(() => draggingRow.classList.add('dragging'), 0); } }); 
                tbody.addEventListener('dragend', (e) => { if (draggingRow) { draggingRow.classList.remove('dragging'); draggingRow = null; updateTableOrder(); } }); 
                tbody.addEventListener('dragover', (e) => { e.preventDefault(); const targetRow = e.target.closest('tr'); if (targetRow && targetRow !== draggingRow && targetRow.tagName === 'TR') { const rect = targetRow.getBoundingClientRect(); const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5; tbody.insertBefore(draggingRow, next ? targetRow.nextSibling : targetRow); } }); 
            }
            
            async function generateCreateTable(dataToPopulate) { 
                if (currentMode === 'create' && (!validateGroupId() || !validateParagraphNum())) { alert('Group ID หรือ ย่อหน้า ที่กรอกไม่ถูกต้อง กรุณาตรวจสอบข้อความแนะนำ'); return; } 
                if (!validatePageEnd()) return;
                const masterGroupId = parseInt(dom.masterGroupIdInput.value);
                const masterPageStart = dom.masterPageStartInput.value;
                const masterParagraphNum = dom.masterParagraphNumInput.value;
                if (!dataToPopulate && !dom.paliInput.value.trim()) { alert('กรุณากรอกเนื้อหาบาลี'); return; }
                if (!masterGroupId || !masterPageStart || !masterParagraphNum) { alert('กรุณากรอกข้อมูลสำคัญให้ครบถ้วน:\n- Group ID\n- หน้าเริ่ม\n- ย่อหน้า'); return; } 
                dom.createDataWorkArea.style.display = 'block'; 
                const table = dom.createSentenceTable; table.innerHTML = createHeader; 
                const tbody = table.querySelector('tbody'); 
                try { 
                    if (dataToPopulate) {
                        dataToPopulate.forEach(docData => {
                            const newId = docData.id || nextAvailableId++;
                            const rowMasterData = { masterGroupId: (docData.sentence_group_id || '').split('-').pop(), masterPageStart: docData.page_start, masterPageEnd: docData.page_end, masterParagraphNum: docData.paragraph_num };
                            addNewRow(tbody, newId, docData.pali_text, docData, rowMasterData);
                        });
                        const maxIdInEdit = Math.max(0, ...dataToPopulate.map(d => d.id || 0));
                        nextAvailableId = maxIdInEdit + 1;
                    } else {
                        const startId = await findLastId("id"); 
                        nextAvailableId = startId + 1; 
                        const masterData = { masterGroupId, masterPageStart, masterPageEnd: dom.masterPageEndInput.value, masterParagraphNum }; 
                        const sourceContent = dom.paliInput.value; 
                        const pePlaceholder = "__PEYALA_PLACEHOLDER__", etcPlaceholder = "__ETC_PLACEHOLDER__"; 
                        let tempContent = sourceContent.replace(/ฯเปฯ/g, pePlaceholder).replace(/ฯลฯ/g, etcPlaceholder); 
                        let lines = tempContent.split(/\r?\n/), finalSentences = []; 
                        lines.forEach(line => { 
                            if (line.trim() === '') return; 
                            const parts = line.split('ฯ');
                            for (let i = 0; i < parts.length; i++) { 
                                let sentence = parts[i].trim(); 
                                if (sentence.length > 0) { 
                                    if (i < parts.length - 1) { sentence += ' ฯ'; } 
                                    let displaySentence = sentence.replace(new RegExp(pePlaceholder, 'g'), 'ฯเปฯ').replace(new RegExp(etcPlaceholder, 'g'), 'ฯลฯ'); 
                                    finalSentences.push(displaySentence.trim()); 
                                } 
                            } 
                        }); 
                        if (finalSentences.length === 0 && sourceContent.trim().length > 0) { 
                            finalSentences.push(sourceContent.trim().replace(new RegExp(pePlaceholder, 'g'), 'ฯเปฯ').replace(new RegExp(etcPlaceholder, 'g'), 'ฯลฯ'));
                        }
                        finalSentences.forEach((sentence, index) => { 
                            const newId = nextAvailableId++; 
                            const currentGroupId = masterData.masterGroupId + index;
                            const rowMasterData = { ...masterData, masterGroupId: currentGroupId };
                            addNewRow(tbody, newId, sentence, null, rowMasterData);
                        });
                    }
                    makeTableDraggable(tbody); 
                    dom.createSaveBtn.disabled = false;
                } catch (error) { updateStatus('create-status-message', `เกิดข้อผิดพลาดในการสร้างตาราง: ${error.message}`, 'error'); } 
            }

            function naturalSortTableData(a, b) {
                const aId = a.fullGroupId || '';
                const bId = b.fullGroupId || '';
                const [aPrefix, aNumStr] = aId.split('-');
                const [bPrefix, bNumStr] = bId.split('-');
                if (aPrefix < bPrefix) return -1;
                if (aPrefix > bPrefix) return 1;
                const aNum = parseInt(aNumStr, 10) || 0;
                const bNum = parseInt(bNumStr, 10) || 0;
                if (aNum < bNum) return -1;
                if (aNum > bNum) return 1;
                return a.originalIndex - b.originalIndex;
            }

            async function saveData() {
                const statusElId = 'create-status-message';
                if (!dom.userNameInput.value.trim()) { alert('กรุณาใส่ชื่อผู้ใช้งาน'); return; }
                const tableRows = Array.from(dom.createSentenceTable.querySelector('tbody').rows);
                if (tableRows.length === 0) { alert('ไม่มีข้อมูลในตารางให้บันทึก'); return; }

                let dataFromTable = tableRows.map((row, index) => {
                    const groupIdNum = row.querySelector('.group-id-input')?.value || '0';
                    return {
                        originalIndex: index,
                        docId: row.dataset.id,
                        groupIdNum: parseInt(groupIdNum),
                        fullGroupId: `${currentPrefix}-${groupIdNum}`,
                        pageStart: parseInt(row.querySelector('.page-start-input')?.value || '0'),
                        pageEnd: parseInt(row.querySelector('.page-end-input')?.value || '0'),
                        paragraphNum: parseInt(row.querySelector('.paragraph-num-input')?.value || '0'),
                        textType: row.querySelector('.text-type-input')?.value,
                        paliText: row.querySelector('.pali-text-input')?.value.trim(),
                    };
                });

                dataFromTable.sort(naturalSortTableData);
                
                try {
                    const initialMasterGroupId = parseInt(dom.masterGroupIdInput.value);
                    const initialMasterParagraphNum = parseInt(dom.masterParagraphNumInput.value);
                    let previousRowPageEnd = 0;
                    for (let i = 0; i < dataFromTable.length; i++) {
                        const currentRow = dataFromTable[i];
                        if (currentRow.pageEnd > 0 && currentRow.pageEnd < currentRow.pageStart) { throw new Error(`แถวที่ ${i + 1} (Group ${currentRow.groupIdNum}): เลขหน้าจบ (${currentRow.pageEnd}) ต้องไม่น้อยกว่าเลขหน้าเริ่ม (${currentRow.pageStart})`); }
                        if (previousRowPageEnd > 0 && currentRow.pageStart < previousRowPageEnd) { throw new Error(`แถวที่ ${i + 1} (Group ${currentRow.groupIdNum}): เลขหน้าเริ่ม (${currentRow.pageStart}) ต้องไม่น้อยกว่าเลขหน้าจบของแถวก่อนหน้า (${previousRowPageEnd})`); }
                        previousRowPageEnd = currentRow.pageEnd > 0 ? currentRow.pageEnd : currentRow.pageStart;
                        if (currentMode === 'create') {
                            if (currentRow.groupIdNum < initialMasterGroupId) { throw new Error(`แถวที่ ${i + 1} (Group ${currentRow.groupIdNum}): Group ID ต้องไม่น้อยกว่าค่าเริ่มต้น (${initialMasterGroupId})`); }
                            if (currentRow.paragraphNum < initialMasterParagraphNum) { throw new Error(`แถวที่ ${i + 1} (Group ${currentRow.groupIdNum}): ย่อหน้าต้องไม่น้อยกว่าค่าเริ่มต้น (${initialMasterParagraphNum})`); }
                        }
                    }
                    if (currentMode === 'create') {
                        const minGroupIdInTable = Math.min(...dataFromTable.map(r => r.groupIdNum));
                        if (minGroupIdInTable <= lastFoundGroupId) { throw new Error(`ภาพรวม: Group ID ที่ใช้ (${minGroupIdInTable}) ต้องมากกว่า ID สูงสุดในระบบ (${lastFoundGroupId})`); }
                    }
                } catch (error) { updateStatus(statusElId, `❌ บันทึกไม่สำเร็จ: ${error.message}`, 'error'); dom.createSaveBtn.disabled = false; return; }

                updateStatus(statusElId, 'กำลังบันทึก...', '');
                dom.createSaveBtn.disabled = true;
                try {
                    const batch = writeBatch(db);
                    const chapterName = document.getElementById('chapter_name').value;
                    const storyName = dom.storyNameInput.value;
                    const sectionName = document.getElementById('section_name').value;
                    const displayFlag = parseInt(document.getElementById('display_flag').value);
                    const firstLineInTextarea = dom.paliInput.value.trim().split(/\r?\n/).find(line => line.trim() !== '') || '';
                    const firstSentenceHash = (currentMode === 'create' && firstLineInTextarea) ? await calculateHash(firstLineInTextarea) : null;

                    dataFromTable.forEach((data, index) => {
                        const docRef = doc(db, "pali_sentences", data.docId);
                        
                        const subOrder = dataFromTable.filter(d => d.fullGroupId === data.fullGroupId).findIndex(d => d.originalIndex === data.originalIndex) + 1;
                            
                        let dataToSave = {
                            id: parseInt(data.docId),
                            sentence_group_id: data.fullGroupId,
                            pali_order: subOrder,
                            book_title: currentBookName, book_part: currentBookPart,
                            chapter_name: chapterName, story_name: storyName, section_name: sectionName,
                            display_flag: displayFlag,
                            page_start: data.pageStart, page_end: data.pageEnd, paragraph_num: data.paragraphNum,
                            text_type: data.textType, pali_text: data.paliText,
                            user_name_pali: dom.userNameInput.value.trim(),
                            timestamp_pali: serverTimestamp(),
                            first_sentence_hash: (index === 0) ? firstSentenceHash : null
                        };
                        if (currentMode === 'create') { Object.assign(dataToSave, { thai_text: "", thai_order: 0, user_name_thai: "", timestamp_thai: null, translation_status: 'untranslated' }); }
                        batch.set(docRef, dataToSave, { merge: true });
                    });

                    await batch.commit();
                    updateStatus(statusElId, 'บันทึกข้อมูลสำเร็จ! กรุณารอสักครู่...', 'success');
                    setTimeout(() => { window.location.reload(); }, 1500);
                } catch (error) { updateStatus(statusElId, `บันทึกไม่สำเร็จ: ${error.message}`, 'error'); dom.createSaveBtn.disabled = false; }
            }
            
            async function fetchDataForFullEdit(groupId) { 
                updateStatus('create-status-message', `กำลังดึงข้อมูล Group ID: ${groupId} เพื่อแก้ไข...`, ''); 
                try { 
                    const q = query(paliCollection, where("sentence_group_id", "==", groupId), orderBy("pali_order")); 
                    const querySnapshot = await getDocs(q); 
                    const data = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); 
                    if (data.length > 0) { populateCreateFormWithData(data); } 
                    else { throw new Error(`ไม่พบข้อมูลสำหรับ Group ID: ${groupId}`); } 
                } catch (error) { updateStatus('create-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); } 
            }

            function populateCreateFormWithData(data) { 
                currentMode = 'super-edit'; 
                document.getElementById('create-view-header').textContent = `โหมดแก้ไขข้อมูลหลัก (Group: ${data[0].sentence_group_id})`; 
                dom.createSaveBtn.textContent = 'อัปเดตข้อมูลหลัก'; 
                const firstDoc = data[0]; 
                dom.chapter_name.value = firstDoc.chapter_name || ''; 
                dom.storyNameInput.value = firstDoc.story_name || ''; 
                dom.section_name.value = firstDoc.section_name || ''; 
                dom.display_flag.value = firstDoc.display_flag !== undefined ? firstDoc.display_flag : '2';
                dom.masterGroupIdInput.value = firstDoc.sentence_group_id.split('-').pop() || ''; 
                dom.masterPageStartInput.value = firstDoc.page_start || ''; 
                dom.masterPageEndInput.value = firstDoc.page_end || ''; 
                dom.masterParagraphNumInput.value = firstDoc.paragraph_num || ''; 
                dom.paliInput.value = data.map(d => d.pali_text).join('\n'); 
                generateCreateTable(data); 
            }

            async function populateCreateDatalists() { 
                try { 
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart)); 
                    const querySnapshot = await getDocs(q); 
                    const chapters = new Set(), stories = new Set(), sections = new Set(); 
                    querySnapshot.forEach(doc => { 
                        const data = doc.data(); 
                        if (data.chapter_name) chapters.add(data.chapter_name); 
                        if (data.story_name) stories.add(data.story_name); 
                        if (data.section_name) sections.add(data.section_name); 
                    }); 
                    fillDatalist('chapter_datalist', chapters); 
                    fillDatalist('story_datalist', stories); 
                    fillDatalist('section_datalist', sections); 
                } catch (error) { console.error("Could not populate create-view datalists:", error); } 
            }
            function fillDatalist(datalistId, dataSet) { 
                const datalistElement = document.getElementById(datalistId); 
                if (datalistElement) { 
                    datalistElement.innerHTML = ''; 
                    Array.from(dataSet).sort().forEach(item => { const option = document.createElement('option'); option.value = item; datalistElement.appendChild(option); }); 
                } 
            }

            async function displayLastEntryInfo() {
                const paliInput = document.getElementById('pali-input');
                paliInput.placeholder = 'กำลังค้นหาประโยคลำดับสูงสุด...';
                try {
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        let highestNum = -1;
                        let lastDocData = null;
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const currentNum = parseInt((data.sentence_group_id || '0-0').split('-')[1], 10);
                            if (currentNum > highestNum) {
                                highestNum = currentNum;
                                lastDocData = data;
                            }
                        });
                        if (lastDocData) {
                             const finalGroupQuery = query(paliCollection, where("sentence_group_id", "==", lastDocData.sentence_group_id), orderBy("pali_order", "desc"), limit(1));
                            const finalGroupSnapshot = await getDocs(finalGroupQuery);
                            if(!finalGroupSnapshot.empty) {
                                const finalSentenceData = finalGroupSnapshot.docs[0].data();
                                const lastSentence = finalSentenceData.pali_text || '';
                                const lastPage = finalSentenceData.page_end || finalSentenceData.page_start || 'ไม่ระบุ';
                                const placeholderText = `ประโยคลำดับสูงสุดของ ${currentBookName} ${currentBookPart} คือ:\n- Group ID: ${finalSentenceData.sentence_group_id}\n- หน้า: ${lastPage}\n- เนื้อหา: ${lastSentence}`;
                                paliInput.placeholder = placeholderText;
                            } else { throw new Error("Could not find the last sentence of the highest group."); }
                        } else { paliInput.placeholder = 'ยังไม่มีข้อมูลในคัมภีร์นี้ เริ่มต้นได้เลย!'; }
                    } else {
                        paliInput.placeholder = 'ยังไม่มีข้อมูลในคัมภีร์นี้ เริ่มต้นได้เลย!';
                    }
                } catch(error) {
                    paliInput.placeholder = 'ไม่สามารถดึงข้อมูลล่าสุดได้...';
                    console.error("Error fetching last entry:", error);
                }
            }

            function initializeTool() {
                const params = new URLSearchParams(window.location.search);
                currentBookName = decodeURIComponent(params.get('bookName') || '');
                currentBookPart = decodeURIComponent(params.get('bookPart') || '');
                currentPrefix = decodeURIComponent(params.get('prefix') || '');
                const editGroupId = decodeURIComponent(params.get('editGroupId') || '');
                if (!currentBookName || !currentPrefix) {
                    dom.mainHeader.textContent = 'ข้อผิดพลาด';
                    dom.container.innerHTML = `<div class="header-bar"><h1>ข้อผิดพลาด</h1></div><p style="text-align:center; color:red;">ไม่พบคัมภีร์หรือ Prefix ที่เลือก<br>กรุณากลับไปที่หน้าแรก</p><br><p style="text-align:center;"><a href="index.html"><button class="secondary">กลับ</button></a></p>`;
                    return;
                }
                dom.mainHeader.textContent = `${currentBookName}`;
                dom.subHeader.textContent = currentBookPart;
                const savedUserName = localStorage.getItem('paliToolUserName');
                if (savedUserName) { dom.userNameInput.value = savedUserName; }
                dom.userNameInput.addEventListener('input', () => { localStorage.setItem('paliToolUserName', dom.userNameInput.value); });
                populateCreateDatalists();
                if (editGroupId) {
                    fetchDataForFullEdit(editGroupId);
                } else {
                    findLastGroupId(); 
                    displayLastEntryInfo();
                }
            }
            
            dom.storyNameInput.addEventListener('blur', checkLastParagraph);         
            dom.masterPageStartInput.addEventListener('blur', checkPageExists);
            dom.masterPageEndInput.addEventListener('blur', validatePageEnd);
            dom.masterGroupIdInput.addEventListener('input', validateGroupId);
            dom.masterParagraphNumInput.addEventListener('input', validateParagraphNum);
            dom.paliInput.addEventListener('blur', checkFirstSentenceHash);

            dom.copyPaliBtn.addEventListener('click', () => {
                const textToCopy = dom.paliInput.value;
                if (!textToCopy) return;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = dom.copyPaliBtn.textContent;
                    dom.copyPaliBtn.textContent = 'คัดลอกแล้ว!';
                    dom.copyPaliBtn.disabled = true;
                    setTimeout(() => {
                        dom.copyPaliBtn.textContent = originalText;
                        dom.copyPaliBtn.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('ไม่สามารถคัดลอกได้: ', err);
                    alert('เกิดข้อผิดพลาด ไม่สามารถคัดลอกข้อความได้');
                });
            });
            
            dom.cleanFormatBtn.addEventListener('click', cleanAndFormat);
            dom.mergeLinesBtn.addEventListener('click', mergeLines);
            dom.undoBtn.addEventListener('click', undoMerge);
            dom.splitBtn.addEventListener('click', () => generateCreateTable(null));
            dom.addRowBtn.addEventListener('click', () => {
                const tbody = dom.createSentenceTable.querySelector('tbody');
                if (!tbody) return; 
                const lastRow = tbody.lastElementChild;
                let masterData = { masterGroupId: '', masterPageStart: '', masterPageEnd: '', masterParagraphNum: '' };
                if (lastRow) {
                    const lastGroupId = parseInt(lastRow.querySelector('.group-id-input')?.value || '0');
                    masterData.masterGroupId = lastGroupId ? lastGroupId + 1 : ''; 
                    masterData.masterPageStart = lastRow.querySelector('.page-start-input')?.value || '';
                    masterData.masterPageEnd = lastRow.querySelector('.page-end-input')?.value || '';
                    masterData.masterParagraphNum = lastRow.querySelector('.paragraph-num-input')?.value || ''; 
                } else {
                    masterData.masterGroupId = dom.masterGroupIdInput.value;
                    masterData.masterPageStart = dom.masterPageStartInput.value;
                    masterData.masterPageEnd = dom.masterPageEndInput.value;
                    masterData.masterParagraphNum = dom.masterParagraphNumInput.value;
                }
                addNewRow(tbody, nextAvailableId++, '', null, masterData);
                updateTableOrder();
            });
            dom.createSaveBtn.addEventListener('click', saveData);
            
            initializeTool();
        });
    </script>
</body>
</html>