<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้าง/แก้ไขข้อมูลบาลี</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        h1, h2 { color: var(--text-dark); margin-top: 0; }
        h1 { border: none; padding: 0; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: var(--text-light); padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: start;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: var(--primary-color); color: var(--white-bg); padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { filter: brightness(90%); }
        .status-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; word-break: break-word; min-height: 1.5em;}
        .status-message.success, .suggestion-text.success { color: #155724; background-color: #d4edda; padding: 10px; border-radius: 4px;}
        .status-message.error, .suggestion-text.error { color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px;}
        .suggestion-text { font-size: 0.9em; color: var(--text-light); margin-top: 5px; min-height: 1.2em; }
        .suggestion-text.warning { color: var(--warning-color); font-weight: bold; }
        .suggestion-text ul { margin: 5px 0 0 20px; padding: 0; list-style-type: '⚠️'; }
        .table-wrapper { margin-top: 20px; overflow-x: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; min-width: 1700px; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #ecf0f1; position: sticky; top: 0; z-index: 1; text-align: center; }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="header-bar">
            <div>
                <h1 id="main-header">กำลังโหลด...</h1>
                <p id="sub-header" style="margin: 5px 0 0; color: #555;"></p>
            </div>
            <a href="index.html" style="text-decoration: none;"><button class="secondary">กลับไปหน้าสารบัญ</button></a>
        </div>

        <div id="create-view">
            <h2 id="create-view-header">หน้าเครื่องมือ (สร้างข้อมูลบาลี)</h2>
            <fieldset> <legend>ข้อมูลผู้ใช้งาน</legend> <input type="text" id="user_name" placeholder="ใส่ชื่อของคุณที่นี่" required> </fieldset>
            <fieldset><legend>ข้อมูลกำกับ</legend>
                <div class="form-grid">
                    <input type="text" id="chapter_name" placeholder="วรรค/บท">
                    <input type="text" id="story_name" placeholder="ชื่อเรื่อง">
                    <input type="text" id="section_name" placeholder="ชื่อตอน">
                    <select id="display_flag" required> <option value="2" selected>2 - พร้อมใช้</option> <option value="1">1 - รอตรวจ</option> <option value="0">0 - ร่าง</option> </select>
                </div>
            </fieldset>
            <fieldset><legend>ข้อมูล Group ID, หน้า, และย่อหน้า (ต้องกรอก*)</legend>
                <div class="form-grid">
                    <div> <label for="master_group_id">Group ID (ตัวเลขเท่านั้น)*</label> <input type="number" id="master_group_id" placeholder="ใส่ ID เริ่มต้น"> <p id="group_id_suggestion" class="suggestion-text"></p></div>
                    <div> <label for="master_page_start">หน้าเริ่ม*</label> <input type="number" id="master_page_start"> <p id="page_check_result" class="suggestion-text"></p> </div>
                    <div> <label for="master_page_end">หน้าจบ</label> <input type="number" id="master_page_end"> </div>
                    <div> <label for="master_paragraph_num">ย่อหน้า*</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div>
                </div>
            </fieldset>
            <fieldset><legend>วางเนื้อหาบาลี</legend>
                <textarea id="pali-input" rows="8"></textarea>
                <p id="hash_check_result" class="suggestion-text"></p>
                <button id="split-btn" style="margin-top:10px;">กดเพื่อแบ่งประโยค</button>
            </fieldset>
            <div id="create-data-work-area" style="display: none;">
                <fieldset><legend>ตารางสร้างข้อมูล</legend><div class="table-wrapper"><table id="create-sentence-table" style="width:100%"></table></div></fieldset>
                <fieldset><legend>บันทึกข้อมูล</legend><button id="create-save-btn" disabled>บันทึกข้อมูลใหม่</button><div id="create-status-message" class="status-message"></div></fieldset>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "pali-exam-builder",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '', currentPrefix = '';
        let currentMode = 'create'; // 'create' or 'super-edit'

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Script Started on create.html");
            const createHeader = `<thead><tr><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr></thead><tbody></tbody>`;

            const userNameInput = document.getElementById('user_name'), storyNameInput = document.getElementById('story_name');
            const masterPageStartInput = document.getElementById('master_page_start'), paliInput = document.getElementById('pali-input');
            const createSaveBtn = document.getElementById('create-save-btn');

            // --- Function Declarations (ประกาศฟังก์ชันทั้งหมดก่อน) ---

            function updateStatus(elementId, message, type) { const el = document.getElementById(elementId); if(el){ el.innerHTML = message; el.className = `suggestion-text ${type}`; if(elementId.includes('status')) el.className = `status-message ${type}`; } }
            async function findLastId(field) { const q = query(paliCollection, orderBy(field, "desc"), limit(1)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) return 0; const data = querySnapshot.docs[0].data(); return data[field] || 0; }
            async function findLastGroupId() { const statusElId = 'group_id_suggestion'; if(!storyNameInput.value.trim()) return; updateStatus(statusElId, `กำลังค้นหา...`, ''); try { const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), orderBy("sentence_group_id", "desc"), limit(1)); const querySnapshot = await getDocs(q); let lastNumber = 0; if (!querySnapshot.empty) { const lastFullId = querySnapshot.docs[0].data().sentence_group_id; lastNumber = parseInt(lastFullId.toString().split('-').pop()) || 0; } updateStatus(statusElId, `ID ล่าสุดที่ใช้ในคัมภีร์นี้คือ: <strong>${currentPrefix}-${lastNumber}</strong>. แนะนำให้ใช้: <strong>${lastNumber + 1}</strong>`, 'success'); } catch (error) { updateStatus(statusElId, `เกิดข้อผิดพลาด: ${error.message}. อาจต้องสร้าง Index`, 'error'); } }
            async function checkLastParagraph() { const paraSuggestionEl = document.getElementById('paragraph_suggestion'); if (!storyNameInput.value.trim()) { paraSuggestionEl.textContent = ''; return; } paraSuggestionEl.textContent = 'กำลังตรวจสอบ...'; try { const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("story_name", "==", storyNameInput.value.trim()), orderBy("paragraph_num", "desc"), limit(1)); const querySnapshot = await getDocs(q); let lastParagraph = 0; if (!querySnapshot.empty) { lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0; } updateStatus('paragraph_suggestion', `เรื่องนี้มีย่อหน้าล่าสุดคือ ${lastParagraph}. แนะนำให้ใช้: ${lastParagraph + 1}`, 'success'); } catch (error) { if (error.code === 'failed-precondition') { updateStatus('paragraph_suggestion', 'เป็นเรื่องใหม่ (ต้องสร้าง Index เพื่อยืนยัน)', 'warning'); } else { updateStatus('paragraph_suggestion', 'เป็นเรื่องใหม่', 'success'); } } }
            async function checkPageExists() { const pageNum = parseInt(masterPageStartInput.value); const resultEl = document.getElementById('page_check_result'); if (!pageNum) { resultEl.innerHTML = ''; return; } resultEl.className = 'suggestion-text'; resultEl.textContent = `กำลังตรวจสอบหน้า ${pageNum}...`; try { const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("page_start", "==", pageNum), limit(5)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { updateStatus('page_check_result', `✅ หน้านี้ยังว่าง`, 'success'); } else { let html = `⚠️ หน้านี้มีข้อมูลแล้ว!`; html += `<ul>`; querySnapshot.forEach(doc => { const data = doc.data(); html += `<li>Group ID: ${data.sentence_group_id}, เนื้อหา: ${data.pali_text.substring(0,30)}...</li>`; }); html += `</ul>`; updateStatus('page_check_result', html, 'warning'); } } catch(error) { updateStatus('page_check_result', `เกิดข้อผิดพลาด: ${error.message} (ต้องสร้าง Index)`, 'error'); } }
            async function calculateHash(text) { const encoder = new TextEncoder(); const data = encoder.encode(text.trim()); const hashBuffer = await crypto.subtle.digest('SHA-256', data); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); }
            function autoFormatPaliText() { let text = paliInput.value; if (!text.trim()) return; let singleLineText = text.replace(/(\r\n|\n|\r)/gm, " "); let formattedText = singleLineText.replace(/\s+/g, '  '); formattedText = formattedText.replace(/\s+ฯ\s*/g, ' ฯ  '); paliInput.value = formattedText.trim(); }
            async function checkFirstSentenceHash() { const content = paliInput.value.trim(); const resultEl = document.getElementById('hash_check_result'); if (!content) { resultEl.innerHTML = ''; return; } const firstLine = content.split(/\s{2,}/)[0] || ''; if (!firstLine) { resultEl.innerHTML = ''; return; } resultEl.className = 'suggestion-text'; resultEl.textContent = 'กำลังตรวจสอบ...'; document.getElementById('split-btn').disabled = true; try { const contentHash = await calculateHash(firstLine); const q = query(paliCollection, where("first_sentence_hash", "==", contentHash), limit(1)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { const docData = querySnapshot.docs[0].data(); updateStatus('hash_check_result', `⚠️ <strong>คำเตือน:</strong> อาจซ้ำกับ Group ID: <strong>${docData.sentence_group_id}</strong>`, 'warning'); } else { updateStatus('hash_check_result', '✅ เนื้อหานี้ไม่น่าจะซ้ำ', 'success'); } } catch(error) { updateStatus('hash_check_result', `เกิดข้อผิดพลาด: ${error.message} (ต้องสร้าง Index)`, 'error'); } finally { document.getElementById('split-btn').disabled = false; } }
            async function generateCreateTable(dataToPopulate) { const masterGroupId = document.getElementById('master_group_id').value; const masterPageStart = masterPageStartInput.value; const masterParagraphNum = document.getElementById('master_paragraph_num').value; if (!paliInput.value.trim() || !masterGroupId || !masterPageStart || !masterParagraphNum) { alert('กรุณากรอกข้อมูลสำคัญให้ครบถ้วน:\n- Group ID\n- หน้าเริ่ม\n- ย่อหน้า\n- เนื้อหาบาลี'); return; } document.getElementById('create-data-work-area').style.display = 'block'; const table = document.getElementById('create-sentence-table'); table.innerHTML = createHeader; const tbody = table.querySelector('tbody'); try { const startId = dataToPopulate ? 0 : await findLastId("id"); const nextId = startId + 1; const masterPageEnd = document.getElementById('master_page_end').value; const sourceLines = dataToPopulate ? dataToPopulate.map(d => d.pali_text) : paliInput.value.split(/\s{2,}/); let validLinesCount = 0; sourceLines.forEach((line, index) => { const cleanedLine = line.trim(); if (cleanedLine.length === 0) return; const row = tbody.insertRow(); const docData = dataToPopulate ? dataToPopulate[index] : null; row.dataset.id = docData ? docData.id : nextId + index; row.innerHTML = `<td class="id-cell">${row.dataset.id}</td><td><input type="number" class="group-id-input" value="${docData ? docData.sentence_group_id.split('-').pop() : masterGroupId}"></td><td><textarea class="pali-text-input" rows="3">${cleanedLine}</textarea></td><td><input type="number" class="page-start-input" value="${docData ? docData.page_start : masterPageStart}"></td><td><input type="number" class="page-end-input" value="${docData ? docData.page_end : masterPageEnd}"></td><td><input type="number" class="paragraph-num-input" value="${docData ? docData.paragraph_num : masterParagraphNum}"></td><td><select class="text-type-input"><option value="ร้อยแก้ว" ${docData && docData.text_type === 'ร้อยแก้ว' ? 'selected' : ''}>ร้อยแก้ว</option><option value="ร้อยกรอง" ${docData && docData.text_type === 'ร้อยกรอง' ? 'selected' : ''}>ร้อยกรอง</option></select></td>`; validLinesCount++; }); if (validLinesCount > 0) { createSaveBtn.disabled = false; } } catch (error) { updateStatus('create-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); } }
            async function saveData() { if (!userNameInput.value.trim()) { alert('กรุณาใส่ชื่อผู้ใช้งาน'); return; } updateStatus('create-status-message', 'กำลังบันทึก...', ''); createSaveBtn.disabled = true; try { const batch = writeBatch(db); const chapterName = document.getElementById('chapter_name').value, storyName = storyNameInput.value, sectionName = document.getElementById('section_name').value; const displayFlag = parseInt(document.getElementById('display_flag').value); const firstLine = paliInput.value.trim().split(/\s{2,}/)[0] || ''; const firstSentenceHash = firstLine ? await calculateHash(firstLine) : null; Array.from(document.getElementById('create-sentence-table').querySelector('tbody').rows).forEach((row, index) => { const docId = row.dataset.id; const groupIdNum = row.querySelector('.group-id-input')?.value || '0'; const fullGroupId = `${currentPrefix}-${groupIdNum}`; const docRef = doc(db, "pali_sentences", docId); let dataToSave = { id: parseInt(docId), sentence_group_id: fullGroupId, pali_order: index + 1, book_title: currentBookName, book_part: currentBookPart, chapter_name: chapterName, story_name: storyName, section_name: sectionName, display_flag: displayFlag, page_start: parseInt(row.querySelector('.page-start-input')?.value) || 0, page_end: parseInt(row.querySelector('.page-end-input')?.value) || 0, paragraph_num: parseInt(row.querySelector('.paragraph-num-input')?.value) || 0, text_type: row.querySelector('.text-type-input')?.value, pali_text: row.querySelector('.pali-text-input')?.value.trim(), user_name_pali: userNameInput.value.trim(), timestamp_pali: serverTimestamp(), first_sentence_hash: (index === 0 ? firstSentenceHash : null) }; if (currentMode === 'create') { Object.assign(dataToSave, { thai_text: "", thai_order: 0, user_name_thai: "", timestamp_thai: null, translation_status: 'untranslated' }); } batch.set(docRef, dataToSave, { merge: true }); }); await batch.commit(); updateStatus('create-status-message', 'บันทึกข้อมูลสำเร็จ!', 'success'); document.getElementById('create-data-work-area').style.display = 'none'; paliInput.value = ''; createSaveBtn.disabled = true; if(currentMode === 'super-edit') { setTimeout(() => { window.location.href = `translate.html?bookName=${encodeURIComponent(currentBookName)}&bookPart=${encodeURIComponent(currentBookPart)}&prefix=${encodeURIComponent(currentPrefix)}`; }, 1500); } } catch (error) { updateStatus('create-status-message', `บันทึกไม่สำเร็จ: ${error.message}`, 'error'); createSaveBtn.disabled = false; } }
            async function fetchDataForFullEdit(groupId) { updateStatus('create-status-message', `กำลังดึงข้อมูล Group ID: ${groupId} เพื่อแก้ไข...`, 'loading'); try { const q = query(paliCollection, where("sentence_group_id", "==", groupId), orderBy("pali_order")); const querySnapshot = await getDocs(q); const data = querySnapshot.docs.map(doc => doc.data()); if (data.length > 0) { populateCreateFormWithData(data); } else { throw new Error('ไม่พบข้อมูล'); } } catch (error) { updateStatus('create-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); } }
            function populateCreateFormWithData(data) { currentMode = 'super-edit'; document.getElementById('create-view-header').textContent = `โหมดแก้ไขข้อมูลหลัก (Group: ${data[0].sentence_group_id})`; createSaveBtn.textContent = 'อัปเดตข้อมูลหลัก'; const firstDoc = data[0]; document.getElementById('chapter_name').value = firstDoc.chapter_name || ''; storyNameInput.value = firstDoc.story_name || ''; document.getElementById('section_name').value = firstDoc.section_name || ''; document.getElementById('display_flag').value = firstDoc.display_flag || '2'; document.getElementById('master_group_id').value = firstDoc.sentence_group_id.split('-').pop() || ''; masterPageStartInput.value = firstDoc.page_start || ''; document.getElementById('master_page_end').value = firstDoc.page_end || ''; document.getElementById('master_paragraph_num').value = firstDoc.paragraph_num || ''; paliInput.value = data.map(d => d.pali_text).join('  '); generateCreateTable(data); }

            function initializeTool() {
                const params = new URLSearchParams(window.location.search);
                currentBookName = decodeURIComponent(params.get('bookName') || '');
                currentBookPart = decodeURIComponent(params.get('bookPart') || '');
                currentPrefix = decodeURIComponent(params.get('prefix') || '');
                const editGroupId = decodeURIComponent(params.get('editGroupId') || '');

                if (!currentBookName || !currentPrefix) {
                    document.getElementById('main-header').textContent = 'ข้อผิดพลาด';
                    document.getElementById('container').innerHTML = `<div class="header-bar"><h1>ข้อผิดพลาด</h1></div><p style="text-align:center; color:red;">ไม่พบคัมภีร์หรือ Prefix ที่เลือกใน URL<br>กรุณากลับไปที่หน้าแรกแล้วเลือกคัมภีร์อีกครั้ง</p><br><p style="text-align:center;"><a href="index.html"><button class="secondary">กลับไปหน้าแรก</button></a></p>`;
                    return;
                }
                
                document.getElementById('main-header').textContent = `${currentBookName}`;
                document.getElementById('sub-header').textContent = currentBookPart;
                const savedUserName = localStorage.getItem('paliToolUserName');
                if (savedUserName) { userNameInput.value = savedUserName; }
                userNameInput.addEventListener('input', () => { localStorage.setItem('paliToolUserName', userNameInput.value); });

                if (editGroupId) {
                    fetchDataForFullEdit(editGroupId);
                }
            }
            
            // --- Event Listeners ---
            storyNameInput.addEventListener('blur', async () => { await checkLastParagraph(); await findLastGroupId(); });
            masterPageStartInput.addEventListener('blur', checkPageExists);
            paliInput.addEventListener('blur', () => { autoFormatPaliText(); checkFirstSentenceHash(); });
            document.getElementById('split-btn').addEventListener('click', () => generateCreateTable(null));
            createSaveBtn.addEventListener('click', saveData);
            
            initializeTool();
        });
    </script>
</body>
</html>