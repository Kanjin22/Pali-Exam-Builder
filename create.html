<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้าง/แก้ไขข้อมูลหลัก (v5.5 - รวมเครื่องมือเตรียมเนื้อหา)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        h1 { color: var(--primary-color); margin-top: 0; }
        .master-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: #eaf1f7; border-radius: 8px; border: 1px solid var(--primary-color); }
        .master-controls label { font-weight: bold; color: var(--text-dark); }
        .master-controls input[type="text"], .master-controls input[type="number"] {
            padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.95rem; width: 100px;
        }
        .control-group { flex: 1; min-width: 150px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: var(--primary-color); color: white; }
        td.order-cell { text-align: center; width: 40px; }
        td:nth-child(2) { width: 40%; } /* Pali text column */
        textarea.pali-text-input, textarea.thai-text-input { width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; resize: vertical; box-sizing: border-box; font-family: 'Sarabun', sans-serif;}
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; width: 90%; box-sizing: border-box; }
        
        .button-group { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover { background-color: #2980b9; }
        button.secondary { background-color: var(--secondary-color); color: white; }
        button.secondary:hover { background-color: #7f8c8d; }
        button.success-btn { background-color: var(--success-color); color: white; }
        button.success-btn:hover { background-color: #229a54; }
        button.danger-btn { background-color: var(--danger-color); color: white; }
        button.danger-btn:hover { background-color: #c0392b; }
        button.warning-btn { background-color: var(--warning-color); color: white; }
        button.warning-btn:hover { background-color: #e67e22; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .status-message { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; display: none; }
        .status-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; border: 1px solid; }
        .status-warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; border: 1px solid; }
        .status-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; border: 1px solid; }
        .status-info { background-color: #e7f3fe; color: #0056b3; border-color: #b3d7ff; border: 1px solid; }

        /* New styles for the preparation view */
        #preparationView {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        #preparationView textarea {
            min-height: 250px;
        }
        #preparationView .button-group {
            justify-content: center;
        }
        #paliInputPageNum {
            width: 150px;
        }
        #tableView { /* Ensure this is properly styled to show/hide */
            display: none; /* Hidden by default, shown after preparation */
        }
        /* New: Styles for Find and Replace */
        .find-replace-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .find-replace-section h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .find-replace-section .form-group {
            margin-bottom: 10px;
        }
        .find-replace-section input[type="text"] {
            width: calc(100% - 20px); /* Adjust width for padding */
            padding: 8px 10px;
            font-size: 0.95rem;
        }
        .find-replace-section button {
            width: auto;
            margin-top: 10px;
        }
    </style>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs, writeBatch, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyDoe7sUNTdaK7uFxvi_Y16C4nCX4kKFiDA",
        authDomain: "pali-exam-builder.firebaseapp.com",
        projectId: "pali-exam-builder",
        storageBucket: "pali-exam-builder.firebasestorage.app",
        messagingSenderId: "783124881115",
        appId: "1:783124881115:web:688f964e586df5b17d36fe",
        measurementId: "G-8HV8B03THV"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const paliCollection = collection(db, "pali_sentences");

    // --- Global Variables ---
    let currentBookName = '';
    let currentBookPart = '';
    let currentPrefix = ''; // e.g., 'ปฐม', 'SN'
    let currentMode = 'create'; // 'create' or 'super-edit'

    let lastFoundGroupId = 0;
    let minAllowedGroupId = 1;

    let lastFoundParagraphNum = 0;
    let lastFoundPageEnd = 0;

    let nextAvailableId = 1; // สำหรับ Pali Order (id ในตาราง), รันต่อจากแถวสุดท้ายในตาราง

    // Declare dom globally, but initialize it inside DOMContentLoaded
    let dom = {}; 

    // --- Utility Functions (rest of these functions remain the same) ---
    // ... (all utility functions like updateStatus, calculateHash, getUrlParameter, etc.)

    // --- Core Logic Functions (rest of these functions remain the same) ---
    // ... (all core logic functions like findLastGroupId, findLastParagraphAndPage, addNewRow, updateTableOrder, splitSentence, deleteRow, loadDataForSuperEdit, validateTableData, saveData)


    // --- Event Listeners and Initialization ---
    // Function to set up the tool initially
    async function initializeTool() {
        // Check authentication status
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                dom.authStatus.textContent = `เข้าสู่ระบบในฐานะ: ${user.isAnonymous ? 'ผู้เยี่ยมชม' : user.uid}`;
                dom.generalStatusMessage.classList.remove('error');
                dom.generalStatusMessage.classList.add('success');
                dom.generalStatusMessage.textContent = 'เข้าสู่ระบบสำเร็จ!';

                // Get parameters from URL (bookName, bookPart, prefix, mode, storyName, groupId)
                currentBookName = getUrlParameter('bookName') || dom.bookNameInput.value.trim();
                currentBookPart = getUrlParameter('bookPart') || dom.bookPartInput.value.trim();
                currentPrefix = getUrlParameter('prefix') || ''; // e.g., "ปฐม" or "SN"
                currentMode = getUrlParameter('mode') || 'create'; // Default to 'create'

                dom.bookNameInput.value = currentBookName;
                dom.bookPartInput.value = currentBookPart;

                // Set UI based on mode
                if (currentMode === 'super-edit') {
                    document.body.classList.add('super-edit-mode');
                    dom.generalStatusMessage.textContent = 'โหมดแก้ไขข้อมูล';
                    // Populate search fields from URL for super-edit
                    dom.searchBookNameInput.value = currentBookName;
                    dom.searchBookPartInput.value = currentBookPart;
                    dom.searchStoryNameInput.value = getUrlParameter('storyName') || '';
                    dom.searchGroupIdInput.value = getUrlParameter('groupId') || '';

                    // If a specific group ID is provided in super-edit mode, load it immediately
                    if (dom.searchBookNameInput.value && dom.searchGroupIdInput.value) {
                         await loadDataForSuperEdit();
                    }
                } else {
                    document.body.classList.remove('super-edit-mode');
                    dom.generalStatusMessage.textContent = 'โหมดสร้างข้อมูลใหม่';
                    // In create mode, we need to find the last IDs to suggest
                    await findLastGroupId(); // Call the UPDATED function
                    await findLastParagraphAndPage(); // This remains the same
                }

            } else {
                dom.authStatus.textContent = 'ยังไม่ได้เข้าสู่ระบบ กำลังเข้าสู่ระบบ...';
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    dom.authStatus.textContent = `ข้อผิดพลาดในการเข้าสู่ระบบ: ${error.message}`;
                    dom.generalStatusMessage.classList.remove('success');
                    dom.generalStatusMessage.classList.add('error');
                    dom.generalStatusMessage.textContent = 'ไม่สามารถเข้าสู่ระบบได้! โปรดตรวจสอบการตั้งค่า Firebase Authentication';
                    console.error("Authentication error:", error);
                }
            }
        });

        // Set up input change listeners for dynamic updates or suggestions
        dom.bookNameInput.addEventListener('change', async () => {
            currentBookName = dom.bookNameInput.value.trim();
            // When book name changes, re-fetch the last Group ID (book-wide)
            if (currentMode === 'create') await findLastGroupId();
        });
        dom.bookPartInput.addEventListener('change', async () => {
            currentBookPart = dom.bookPartInput.value.trim();
            // Note: findLastGroupId no longer depends on bookPart.
            // findLastParagraphAndPage still does, if needed.
            if (currentMode === 'create') await findLastParagraphAndPage();
        });
        dom.storyNameInput.addEventListener('change', async () => {
            // When story name changes, re-fetch the last paragraph/page end (story-specific)
            if (currentMode === 'create') await findLastParagraphAndPage();
        });
    }


    // DOMContentLoaded ensures the HTML is fully loaded before running script
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize dom object here, guaranteeing elements are loaded
        dom = {
            generalStatusMessage: document.getElementById('general-status-message'),
            createStatusMessage: document.getElementById('create-status-message'),
            authStatus: document.getElementById('auth-status'),
            userNameInput: document.getElementById('user_name'),
            bookNameInput: document.getElementById('book_name'),
            bookPartInput: document.getElementById('book_part'),
            chapterNameInput: document.getElementById('chapter_name'),
            storyNameInput: document.getElementById('story_name'),
            sectionNameInput: document.getElementById('section_name'),
            displayFlagInput: document.getElementById('display_flag'),
            paliInput: document.getElementById('pali_input'),
            masterGroupIdInput: document.getElementById('master_group_id_input'),
            masterPageStartInput: document.getElementById('master_page_start_input'),
            masterPageEndInput: document.getElementById('master_page_end_input'),
            masterParagraphNumInput: document.getElementById('master_paragraph_num_input'),
            groupIdSuggestion: document.getElementById('group_id_suggestion'),
            paragraphNumSuggestion: document.getElementById('paragraph_num_suggestion'),
            generateTableBtn: document.getElementById('generate_table_btn'),
            clearTableBtn: document.getElementById('clear_table_btn'),
            createSentenceTable: document.getElementById('create_sentence_table'),
            createAddRowBtn: document.getElementById('create_add_row_btn'),
            createSaveBtn: document.getElementById('create_save_btn'),
            createBackBtn: document.getElementById('create_back_btn'),
            // Super Edit Mode elements
            searchBookNameInput: document.getElementById('search_book_name'),
            searchBookPartInput: document.getElementById('search_book_part'),
            searchStoryNameInput: document.getElementById('search_story_name'),
            searchGroupIdInput: document.getElementById('search_group_id'),
            searchDataBtn: document.getElementById('search_data_btn'),
            clearSearchBtn: document.getElementById('clear_search_btn'),
            createSection: document.querySelector('.create-section'),
            superEditSection: document.querySelector('.super-edit-form-section')
        };

        // Event Listener for Generate Table Button
        dom.generateTableBtn.addEventListener('click', async () => {
            const paliText = dom.paliInput.value.trim();
            if (!paliText) {
                updateStatus('create-status-message', 'กรุณาใส่ข้อความบาลีหลักเพื่อแบ่งประโยค', 'warning');
                return;
            }

            if (!dom.masterGroupIdInput.value.trim()) {
                updateStatus('create-status-message', 'กรุณาใส่ Group ID เริ่มต้น', 'warning');
                return;
            }
             if (!dom.masterPageStartInput.value.trim() || !dom.masterPageEndInput.value.trim()) {
                updateStatus('create-status-message', 'กรุณาใส่ Page Start และ Page End เริ่มต้น', 'warning');
                return;
            }
             if (!dom.masterParagraphNumInput.value.trim()) {
                updateStatus('create-status-message', 'กรุณาใส่ Paragraph Num เริ่มต้น', 'warning');
                return;
            }


            const sentences = paliText.split(/([.!?].*?\s*)/).filter(s => s.trim().length > 0);
            const tbody = dom.createSentenceTable.querySelector('tbody');
            tbody.innerHTML = ''; // Clear previous rows

            // Prepare master data for the first set of rows
            const initialMasterData = {
                masterGroupId: dom.masterGroupIdInput.value,
                masterPageStart: dom.masterPageStartInput.value,
                masterPageEnd: dom.masterPageEndInput.value,
                masterParagraphNum: dom.masterParagraphNumInput.value,
            };

            let currentSentenceNumber = 1;
            sentences.forEach(sentence => {
                const masterDataForCurrentRow = { ...initialMasterData }; // Copy initial data
                addNewRow(tbody, currentSentenceNumber++, sentence.trim(), null, masterDataForCurrentRow);
            });
            updateTableOrder();
            updateStatus('create-status-message', `แบ่งข้อความเป็น ${sentences.length} ประโยคแล้ว`, 'success');
        });

        // Event Listener for Clear Table Button
        dom.clearTableBtn.addEventListener('click', () => {
            dom.createSentenceTable.querySelector('tbody').innerHTML = '';
            dom.paliInput.value = '';
            nextAvailableId = 1; // Reset sentence ID counter
            updateStatus('create-status-message', 'ตารางถูกล้างแล้ว', 'info');
        });

        // Event Listener for Search Data Button (Super Edit Mode)
        dom.searchDataBtn.addEventListener('click', loadDataForSuperEdit);

        // Event Listener for Clear Search Button (Super Edit Mode)
        dom.clearSearchBtn.addEventListener('click', () => {
            dom.searchBookNameInput.value = '';
            dom.searchBookPartInput.value = '';
            dom.searchStoryNameInput.value = '';
            dom.searchGroupIdInput.value = '';
            dom.createSentenceTable.querySelector('tbody').innerHTML = '';
            updateStatus('create-status-message', 'ล้างการค้นหาแล้ว', 'info');
        });

        // Event Listener for Back to Main Button
        dom.createBackBtn.addEventListener('click', () => {
            const params = new URLSearchParams({ bookName: currentBookName, bookPart: currentBookPart, prefix: currentPrefix });
            window.location.href = `translate.html?${params.toString()}`;
        });

        // Event Listener for Add Row Button
        dom.createAddRowBtn.addEventListener('click', () => {
            const tbody = dom.createSentenceTable.querySelector('tbody');
            const lastRow = tbody.lastElementChild;
            const masterData = {};

            // Get values from the last row if it exists, otherwise from master inputs
            if (lastRow) {
                masterData.masterGroupId = lastRow.querySelector('.group-id-input')?.value || '';
                masterData.masterPageStart = lastRow.querySelector('.page-start-input')?.value || '';
                masterData.masterPageEnd = lastRow.querySelector('.page-end-input')?.value || '';
                masterData.masterParagraphNum = lastRow.querySelector('.paragraph-num-input')?.value || '';
            } else {
                // Fallback to master inputs if no rows exist
                masterData.masterGroupId = dom.masterGroupIdInput.value;
                masterData.masterPageStart = dom.masterPageStartInput.value;
                masterData.masterPageEnd = dom.masterPageEndInput.value;
                masterData.masterParagraphNum = dom.masterParagraphNumInput.value;
            }
            
            if (currentMode !== 'super-edit' && lastRow) {
                masterData.masterParagraphNum = parseInt(masterData.masterParagraphNum) + 1;
            }

            addNewRow(tbody, nextAvailableId++, '', null, masterData);
            updateTableOrder();
        });

        dom.createSaveBtn.addEventListener('click', saveData); // ปุ่มบันทึกข้อมูล
        
        // Initialize the tool after all event listeners are set up
        initializeTool();
    });
</script>
</body>
</html>