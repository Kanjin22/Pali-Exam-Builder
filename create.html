<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือข้อมูลบาลี (v3.3 - Datalist & Refresh)</title>
    <!-- (CSS Style เหมือนเดิมทั้งหมด) -->
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        h1, h2 { color: var(--text-dark); margin-top: 0; }
        h1 { border: none; padding: 0; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: var(--text-light); padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: start;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: var(--primary-color); color: var(--white-bg); padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { filter: brightness(90%); }
        .view { display: none; }
        .view.active { display: block; }
        .status-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; word-break: break-word; min-height: 1.5em;}
        .status-message.success, .suggestion-text.success { color: #155724; background-color: #d4edda; padding: 10px; border-radius: 4px;}
        .status-message.error, .suggestion-text.error { color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px;}
        .suggestion-text { font-size: 0.9em; color: var(--text-light); margin-top: 5px; min-height: 1.2em; }
        .suggestion-text.warning { color: var(--warning-color); font-weight: bold; }
        .suggestion-text ul { margin: 5px 0 0 20px; padding: 0; list-style-type: '⚠️'; }
        #edit-view-content { display: none; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        #pali-display-panel { background-color: #fafafa; padding: 15px; border-radius: 5px; border: 1px solid #eee; height: fit-content; position: sticky; top: 20px; }
        #pali-display-panel h3 { margin-top: 0; }
        #pali-display-panel p { margin: 0 0 1em 0; padding: 0.5em; border-bottom: 1px dotted #ccc; transition: background-color 0.3s; }
        #pali-display-panel p.highlight { background-color: #fff8e1; }
        #group-results div { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        #group-results div:hover { background-color: #f0f8ff; }
        .edit-buttons { display: flex; align-items: center; gap: 8px; }
        .edit-buttons button { padding: 5px 10px; height: auto; font-size: 14px; }
        .status-badge { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; color: #fff; }
        .status-untranslated { background-color: var(--danger-color); }
        .status-completed { background-color: var(--success-color); }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="header-bar">
            <div><h1 id="main-header">กำลังโหลด...</h1><p id="sub-header" style="margin: 5px 0 0; color: #555;"></p></div>
            <div id="view-switcher" style="display: flex; gap: 10px;">
                <a href="index.html" style="text-decoration: none;"><button class="secondary">กลับไปหน้าสารบัญ</button></a>
                <button id="go_to_edit_view_btn" class="success">ไปหน้าแก้ไข</button>
                <button id="go_to_create_view_btn" class="secondary" style="display: none;">กลับไปหน้าสร้างข้อมูล</button>
            </div>
        </div>
        <div id="create-view" class="view">
            <h2 id="create-view-header">หน้าเครื่องมือ (สร้างข้อมูลบาลี)</h2>
            <fieldset> <legend>ข้อมูลผู้ใช้งาน</legend> <input type="text" id="user_name" placeholder="ใส่ชื่อของคุณที่นี่" required> </fieldset>
            <!-- === ส่วนที่แก้ไข: เพิ่ม attribute 'list' และ datalist === -->
            <fieldset><legend>ข้อมูลกำกับ</legend>
                <div class="form-grid">
                    <input type="text" id="chapter_name" placeholder="วรรค/บท" list="chapter_datalist">
                    <datalist id="chapter_datalist"></datalist>
                    <input type="text" id="story_name" placeholder="ชื่อเรื่อง" list="story_datalist">
                    <datalist id="story_datalist"></datalist>
                    <input type="text" id="section_name" placeholder="ชื่อตอน" list="section_datalist">
                    <datalist id="section_datalist"></datalist>
                    <select id="display_flag" required> <option value="2" selected>2 - พร้อมใช้</option> <option value="1">1 - รอตรวจ</option> <option value="0">0 - ร่าง</option> </select>
                </div>
            </fieldset>
            <fieldset><legend>ข้อมูล Group ID, หน้า, และย่อหน้า (ต้องกรอก*)</legend><div class="form-grid"><div> <label for="master_group_id">Group ID (ตัวเลขเท่านั้น)*</label> <input type="number" id="master_group_id" placeholder="ใส่ ID เริ่มต้น"> <p id="group_id_suggestion" class="suggestion-text"></p></div><div> <label for="master_page_start">หน้าเริ่ม*</label> <input type="number" id="master_page_start"> <p id="page_check_result" class="suggestion-text"></p> </div><div> <label for="master_page_end">หน้าจบ</label> <input type="number" id="master_page_end"> </div><div> <label for="master_paragraph_num">ย่อหน้า*</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div></div></fieldset>
            <fieldset><legend>วางเนื้อหาบาลี</legend><textarea id="pali-input" rows="8"></textarea><p id="hash_check_result" class="suggestion-text"></p><button id="split-btn" style="margin-top:10px;">กดเพื่อแบ่งประโยค</button></fieldset>
            <div id="create-data-work-area" style="display: none;"><fieldset><legend>ตารางสร้างข้อมูล</legend><div class="table-wrapper"><table id="create-sentence-table" style="width:100%"></table></div></fieldset><fieldset><legend>บันทึกข้อมูล</legend><button id="create-save-btn" disabled>บันทึกข้อมูล</button><div id="create-status-message" class="status-message"></div></fieldset></div>
        </div>
        <div id="edit-view" class="view">
             <h2>หน้าแก้ไข (เพิ่มคำแปลไทย)</h2>
            <fieldset id="edit-mode-selector"><legend>ค้นหากลุ่มข้อมูลเพื่อแก้ไข</legend><div class="form-grid"><input type="text" id="search_story_name" list="story_name_datalist_for_search" placeholder="เลือก/พิมพ์ชื่อเรื่อง"><datalist id="story_name_datalist_for_search"></datalist><input type="number" id="search_page_num" placeholder="ใส่เลขหน้า"><button id="search_groups_btn">ค้นหากลุ่ม</button></div><div id="group-results" style="margin-top: 15px;"></div></fieldset>
            <div id="edit-view-content" style="display: none;"><div id="pali-display-panel"><h3 id="pali-display-header">เนื้อหาบาลี (สำหรับอ้างอิง)</h3><div id="pali-display-text"></div></div><div id="translation-panel"><h3>ตารางแก้ไขคำแปล</h3><div class="table-wrapper"><table id="edit-sentence-table" style="width:100%"></table></div><fieldset><legend>บันทึกการแก้ไข</legend><button id="edit-save-btn" disabled>อัปเดตคำแปล</button><div id="edit-status-message" class="status-message"></div></fieldset></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = { /* ... YOUR FIREBASE CONFIG ... */ };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '', currentPrefix = '';
        let currentMode = 'create';

        document.addEventListener('DOMContentLoaded', () => {
            const createHeader = `<thead><tr><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr></thead><tbody></tbody>`;
            const editHeader = `<thead><tr><th>ID</th><th>ลำดับบาลี</th><th>เนื้อหาบาลี</th><th>ลำดับแปลไทย</th><th>เนื้อหาคำแปลไทย</th></tr></thead><tbody></tbody>`;
            const dom = { container: document.getElementById('container'), mainHeader: document.getElementById('main-header'), subHeader: document.getElementById('sub-header'), createView: document.getElementById('create-view'), editView: document.getElementById('edit-view'), goToEditBtn: document.getElementById('go_to_edit_view_btn'), goToCreateBtn: document.getElementById('go_to_create_view_btn'), createDataWorkArea: document.getElementById('create-data-work-area'), editViewContent: document.getElementById('edit-view-content'), createSentenceTable: document.getElementById('create-sentence-table'), editSentenceTable: document.getElementById('edit-sentence-table'), createSaveBtn: document.getElementById('create-save-btn'), editSaveBtn: document.getElementById('edit-save-btn'), userNameInput: document.getElementById('user_name'), storyNameInput: document.getElementById('story_name'), masterPageStartInput: document.getElementById('master_page_start'), paliInput: document.getElementById('pali-input') };

            function updateStatus(elementId, message, type) { const el = document.getElementById(elementId); if(el){ el.innerHTML = message; el.className = `suggestion-text ${type}`; if(elementId.includes('status')) el.className = `status-message ${type}`; } }
            async function findLastId(field) { const q = query(paliCollection, orderBy(field, "desc"), limit(1)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) return 0; const data = querySnapshot.docs[0].data(); return data[field] || 0; }
            function switchView(viewToShow) { currentMode = (viewToShow === 'create' || viewToShow === 'super-edit') ? viewToShow : 'translate'; dom.createView.classList.toggle('active', viewToShow === 'create' || viewToShow === 'super-edit'); dom.editView.classList.toggle('active', viewToShow === 'edit' || viewToShow === 'translate'); dom.goToEditBtn.style.display = (viewToShow === 'create' || viewToShow === 'super-edit') ? 'inline-block' : 'none'; dom.goToCreateBtn.style.display = (viewToShow === 'edit' || viewToShow === 'translate') ? 'inline-block' : 'none'; dom.createDataWorkArea.style.display = 'none'; dom.editViewContent.style.display = 'none'; }
            function resetCreateForm() { dom.createDataWorkArea.style.display = 'none'; dom.createSaveBtn.disabled = true; const fieldsToClear = ['chapter_name', 'story_name', 'section_name', 'master_group_id', 'master_page_start', 'master_page_end', 'master_paragraph_num', 'pali-input']; fieldsToClear.forEach(id => document.getElementById(id).value = ''); const suggestionsToClear = ['group_id_suggestion', 'page_check_result', 'paragraph_suggestion', 'hash_check_result']; suggestionsToClear.forEach(id => document.getElementById(id).textContent = ''); document.getElementById('create-view-header').textContent = 'หน้าเครื่องมือ (สร้างข้อมูลบาลี)'; dom.createSaveBtn.textContent = 'บันทึกข้อมูลใหม่'; }
            
            // === ฟังก์ชันใหม่ ===
            async function populateCreateDatalists() {
                try {
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart));
                    const querySnapshot = await getDocs(q);
                    const chapters = new Set(), stories = new Set(), sections = new Set();
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.chapter_name) chapters.add(data.chapter_name);
                        if (data.story_name) stories.add(data.story_name);
                        if (data.section_name) sections.add(data.section_name);
                    });
                    fillDatalist('chapter_datalist', chapters);
                    fillDatalist('story_datalist', stories);
                    fillDatalist('section_datalist', sections);
                } catch (error) { console.error("Could not populate create-view datalists:", error); }
            }
            function fillDatalist(datalistId, dataSet) {
                const datalistElement = document.getElementById(datalistId);
                if (datalistElement) {
                    datalistElement.innerHTML = '';
                    Array.from(dataSet).sort().forEach(item => { const option = document.createElement('option'); option.value = item; datalistElement.appendChild(option); });
                }
            }
            // ==================

            async function findLastGroupId() { /* (โค้ดเหมือนเดิม) */ }
            async function checkLastParagraph() { /* (โค้ดเหมือนเดิม) */ }
            async function checkPageExists() { /* (โค้ดเหมือนเดิม) */ }
            async function calculateHash(text) { /* (โค้ดเหมือนเดิม) */ }
            async function checkFirstSentenceHash() { /* (โค้ดเหมือนเดิม) */ }
            async function generateCreateTable(dataToPopulate) { /* (โค้ดเหมือนเดิม) */ }
            
            // === ฟังก์ชันที่แก้ไข ===
            async function saveData() {
                const statusElId = (currentMode === 'create' || currentMode === 'super-edit') ? 'create-status-message' : 'edit-status-message';
                const saveBtn = (currentMode === 'create' || currentMode === 'super-edit') ? dom.createSaveBtn : dom.editSaveBtn;
                if (!dom.userNameInput.value.trim()) { alert('กรุณาใส่ชื่อผู้ใช้งาน'); return; }
                updateStatus(statusElId, 'กำลังบันทึก...', '');
                saveBtn.disabled = true;
                try {
                    const batch = writeBatch(db);
                    // (ตรรกะการสร้าง batch เหมือนเดิม)
                    await batch.commit();
                    updateStatus(statusElId, 'บันทึกข้อมูลสำเร็จ! กำลังรีเฟรชหน้า...', 'success');
                    setTimeout(() => { window.location.reload(); }, 1500);
                } catch (error) {
                    updateStatus(statusElId, `บันทึกไม่สำเร็จ: ${error.message}`, 'error');
                    saveBtn.disabled = false;
                }
            }

            async function searchGroupsToEdit() { /* (โค้ดเหมือนเดิม) */ }
            async function fetchDataForTranslate(groupId) { /* (โค้ดเหมือนเดิม) */ }
            function generateEditTable(data) { /* (โค้ดเหมือนเดิม) */ }
            async function populateStoryDatalistForSearch(){ /* (โค้ดเหมือนเดิม) */ }
            async function fetchDataForFullEdit(groupId) { /* (โค้ดเหมือนเดิม) */ }
            function populateCreateFormWithData(data) { /* (โค้ดเหมือนเดิม) */ }

            function initializeTool() {
                const params = new URLSearchParams(window.location.search);
                currentBookName = decodeURIComponent(params.get('bookName') || '');
                currentBookPart = decodeURIComponent(params.get('bookPart') || '');
                currentPrefix = decodeURIComponent(params.get('prefix') || '');
                if (!currentBookName || !currentPrefix) { /* ... handle error ... */ }
                dom.mainHeader.textContent = `${currentBookName}`;
                dom.subHeader.textContent = currentBookPart;
                const savedUserName = localStorage.getItem('paliToolUserName');
                if (savedUserName) { dom.userNameInput.value = savedUserName; }
                dom.userNameInput.addEventListener('input', () => { localStorage.setItem('paliToolUserName', dom.userNameInput.value); });
                switchView('create');
                populateStoryDatalistForSearch();
                populateCreateDatalists(); // <-- เรียกใช้ฟังก์ชันใหม่
            }
            
            // --- Event Listeners ---
            dom.goToEditBtn.addEventListener('click', () => switchView('edit'));
            dom.goToCreateBtn.addEventListener('click', () => { switchView('create'); resetCreateForm(); });
            dom.storyNameInput.addEventListener('blur', async () => { await checkLastParagraph(); await findLastGroupId(); });
            dom.masterPageStartInput.addEventListener('blur', checkPageExists);
            dom.paliInput.addEventListener('blur', checkFirstSentenceHash);
            document.getElementById('split-btn').addEventListener('click', () => generateCreateTable(null));
            dom.createSaveBtn.addEventListener('click', () => saveData());
            document.getElementById('search_groups_btn').addEventListener('click', searchGroupsToEdit);
            dom.editSaveBtn.addEventListener('click', () => saveData());

            initializeTool();
        });
    </script>
</body>
</html>