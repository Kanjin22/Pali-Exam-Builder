<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือข้อมูลบาลี (v2.8)</title>
    <!-- (CSS Style เหมือนเดิม) -->
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        h1, h2 { color: var(--text-dark); margin-top: 0; }
        h1 { border: none; padding: 0; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: var(--text-light); padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: start;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: var(--primary-color); color: var(--white-bg); padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { filter: brightness(90%); }
        .view { display: none; }
        .view.active { display: block; }
        .status-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; word-break: break-word; }
        .status-message.success { color: #155724; background-color: #d4edda; }
        .status-message.error { color: #721c24; background-color: #f8d7da; }
        .suggestion-text { font-size: 0.9em; color: var(--text-light); margin-top: 5px; min-height: 1.2em; }
        .suggestion-text.error { color: var(--danger-color); font-weight: bold; }
        .suggestion-text.success { color: var(--success-color); font-weight: bold; }
        .suggestion-text.warning { color: var(--warning-color); font-weight: bold; }
        #edit-view-content { display: none; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        #pali-display-panel { background-color: #fafafa; padding: 15px; border-radius: 5px; border: 1px solid #eee; height: fit-content; position: sticky; top: 20px; }
        #pali-display-panel h3 { margin-top: 0; }
        #pali-display-panel p { margin: 0 0 1em 0; padding: 0.5em; border-bottom: 1px dotted #ccc; transition: background-color 0.3s; }
        #pali-display-panel p.highlight { background-color: #fff8e1; }
        #group-results div { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #group-results div:hover { background-color: #f0f8ff; }
        .status-badge { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; color: #fff; }
        .status-untranslated { background-color: var(--danger-color); }
        .status-completed { background-color: var(--success-color); }
    </style>
</head>
<body>
    <div class="container" id="container">
        <!-- (Header and View Switcher เหมือนเดิม) -->

        <!-- Create View -->
        <div id="create-view" class="view">
            <h2>หน้าเครื่องมือ (สร้างข้อมูลบาลี)</h2>
            <fieldset> <legend>ข้อมูลผู้ใช้งาน</legend> <input type="text" id="user_name" placeholder="ใส่ชื่อของคุณที่นี่" required> </fieldset>
            <fieldset><legend>ข้อมูลกำกับ</legend>
                <div class="form-grid">
                    <input type="text" id="chapter_name" placeholder="วรรค/บท">
                    <input type="text" id="story_name" placeholder="ชื่อเรื่อง">
                    <input type="text" id="section_name" placeholder="ชื่อตอน">
                    <select id="display_flag" required> <option value="2" selected>2 - พร้อมใช้</option> <option value="1">1 - รอตรวจ</option> <option value="0">0 - ร่าง</option> </select>
                </div>
            </fieldset>
            <fieldset><legend>ข้อมูล Group ID, หน้า, และย่อหน้า (ต้องกรอก*)</legend>
                <div class="form-grid">
                    <div> <label for="master_group_id">Group ID (ตัวเลขเท่านั้น)*</label> <input type="number" id="master_group_id" placeholder="ใส่ ID เริ่มต้น"> <p id="group_id_suggestion" class="suggestion-text">ระบบจะแนะนำ ID ล่าสุดให้เมื่อเลือกเรื่อง</p></div>
                    <div> <label for="master_page_start">หน้าเริ่ม*</label> <input type="number" id="master_page_start"> <p id="page_check_result" class="suggestion-text"></p> </div>
                    <div> <label for="master_page_end">หน้าจบ</label> <input type="number" id="master_page_end"> </div>
                    <div> <label for="master_paragraph_num">ย่อหน้า*</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div>
                </div>
            </fieldset>
            <fieldset><legend>วางเนื้อหาบาลี</legend>
                <textarea id="pali-input" rows="8"></textarea>
                <p id="hash_check_result" class="suggestion-text"></p>
                <button id="split-btn" style="margin-top:10px;">กดเพื่อแบ่งประโยค</button>
            </fieldset>
            <div id="create-data-work-area" style="display: none;">
                <fieldset><legend>ตารางสร้างข้อมูล</legend><div class="table-wrapper"><table id="create-sentence-table" style="width:100%"></table></div></fieldset>
                <fieldset><legend>บันทึกข้อมูล</legend><button id="create-save-btn" disabled>บันทึกข้อมูลใหม่</button><div id="create-status-message" class="status-message"></div></fieldset>
            </div>
        </div>

        <!-- Edit View -->
        <div id="edit-view" class="view">
             <!-- (HTML ในส่วนนี้เหมือนเดิม) -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
        // --- ใส่ firebaseConfig ของคุณที่นี่ ---
        const firebaseConfig = { /* ... YOUR FIREBASE CONFIG ... */ };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '', currentPrefix = '';

        document.addEventListener('DOMContentLoaded', () => {
            // (Cache DOM elements เหมือนเดิม)
            const storyNameInput = document.getElementById('story_name');

            // --- Event Listeners ---
            // (event listeners อื่นๆ เหมือนเดิม)
            storyNameInput.addEventListener('blur', async () => {
                await checkLastParagraph();
                await findLastGroupId();
            });

            // --- ฟังก์ชันที่แก้ไข: checkLastParagraph ---
            async function checkLastParagraph() {
                const paraSuggestionEl = document.getElementById('paragraph_suggestion');
                if (!storyNameInput.value.trim()) {
                    paraSuggestionEl.textContent = '';
                    return;
                }
                paraSuggestionEl.textContent = 'กำลังตรวจสอบย่อหน้า...';
                try {
                    const q = query(paliCollection, 
                        where("book_title", "==", currentBookName), 
                        where("book_part", "==", currentBookPart), 
                        where("story_name", "==", storyNameInput.value.trim()), 
                        orderBy("paragraph_num", "desc"), 
                        limit(1));
                    const querySnapshot = await getDocs(q);
                    let lastParagraph = 0;
                    if (!querySnapshot.empty) {
                        lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0;
                    }
                    
                    if (lastParagraph > 0) {
                        paraSuggestionEl.textContent = `เรื่องนี้มีย่อหน้าล่าสุดคือ ${lastParagraph}. แนะนำให้ใช้: ${lastParagraph + 1}`;
                    } else {
                        paraSuggestionEl.textContent = 'เป็นเรื่องใหม่ แนะนำให้เริ่มย่อหน้าที่ 1';
                    }
                } catch (error) {
                    paraSuggestionEl.textContent = 'เป็นเรื่องใหม่ (ต้องสร้าง Index เพื่อยืนยัน)';
                }
            }
            
            // --- ฟังก์ชันที่แก้ไข: findLastGroupId ---
            async function findLastGroupId() {
                const statusElId = 'group_id_suggestion';
                updateStatus(statusElId, `กำลังค้นหา Group ID ล่าสุด...`, '');
                try {
                    const q = query(paliCollection, 
                        where("book_title", "==", currentBookName), 
                        where("book_part", "==", currentBookPart), 
                        orderBy("sentence_group_id", "desc"), 
                        limit(1));
                    const querySnapshot = await getDocs(q);
                    let lastNumber = 0;
                    if (!querySnapshot.empty) {
                        const lastFullId = querySnapshot.docs[0].data().sentence_group_id;
                        lastNumber = parseInt(lastFullId.toString().split('-').pop()) || 0;
                    }
                    updateStatus(statusElId, `ID ล่าสุดที่ใช้ในคัมภีร์นี้คือ: ${currentPrefix}-${lastNumber}. แนะนำให้ใช้: ${lastNumber + 1}`, 'success');
                } catch (error) {
                    updateStatus(statusElId, `เกิดข้อผิดพลาด: ${error.message}. อาจต้องสร้าง Index`, 'error');
                }
            }

            // --- ฟังก์ชันที่แก้ไข: generateCreateTable ---
            async function generateCreateTable() {
                // --- ส่วนที่เพิ่มเข้ามา: ตรวจสอบข้อมูลก่อน ---
                const masterGroupId = document.getElementById('master_group_id').value;
                const masterPageStart = document.getElementById('master_page_start').value;
                const masterParagraphNum = document.getElementById('master_paragraph_num').value;
                const paliInput = document.getElementById('pali-input');

                if (!paliInput.value.trim() || !masterGroupId || !masterPageStart || !masterParagraphNum) {
                    alert('กรุณากรอกข้อมูลสำคัญให้ครบถ้วน:\n- Group ID\n- หน้าเริ่ม\n- ย่อหน้า\n- เนื้อหาบาลี');
                    return;
                }
                
                // (โค้ดส่วนที่เหลือของฟังก์ชันนี้เหมือนเดิมทุกประการ)
                document.getElementById('create-data-work-area').style.display = 'block';
                const table = document.getElementById('create-sentence-table');
                table.innerHTML = `<thead><tr><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                try {
                    const nextId = await findLastId("id") + 1;
                    const masterPageEnd = document.getElementById('master_page_end').value;
                    let validLinesCount = 0;
                    paliInput.value.split(/\r?\n/).forEach((line, index) => {
                        const cleanedLine = line.trim(); if (cleanedLine.length === 0) return;
                        const row = tbody.insertRow();
                        row.dataset.id = nextId + index;
                        row.innerHTML = `<td class="id-cell">${nextId + index}</td><td><input type="number" class="group-id-input" value="${masterGroupId}"></td><td><textarea class="pali-text-input" rows="3">${cleanedLine}</textarea></td><td><input type="number" class="page-start-input" value="${masterPageStart}"></td><td><input type="number" class="page-end-input" value="${masterPageEnd}"></td><td><input type="number" class="paragraph-num-input" value="${masterParagraphNum}"></td><td><select class="text-type-input"><option value="ร้อยแก้ว">ร้อยแก้ว</option><option value="ร้อยกรอง">ร้อยกรอง</option></select></td>`;
                        validLinesCount++;
                    });
                    if (validLinesCount > 0) { document.getElementById('create-save-btn').disabled = false; }
                } catch(error) { updateStatus('create-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); }
            }
            
            // (ฟังก์ชันอื่นๆ ทั้งหมดเหมือนเดิม)
            
            initializeTool();
        });
    </script>
</body>
</html>