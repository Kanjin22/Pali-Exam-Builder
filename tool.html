<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เครื่องมือข้อมูลบาลี (v2.1)</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #2c3e50; }
    .container { max-width: 960px; margin: auto; background: white; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { margin-top: 0; }
    textarea, input, select { width: 100%; padding: 8px; font-family: 'Sarabun', sans-serif; margin-bottom: 10px; }
    button { padding: 10px 20px; border: none; border-radius: 4px; background: #3498db; color: white; cursor: pointer; }
    button:hover { background: #2980b9; }
    .error { color: red; margin-top: 10px; }
    .success { color: green; margin-top: 10px; }
    .section { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #ecf0f1; }
  </style>
</head>
<body>
  <div class="container" id="container">
    <h1>กำลังโหลดเครื่องมือ...</h1>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_REAL_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "pali-exam-builder",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const paliCollection = collection(db, "pali_sentences");

    let currentBookName = '', currentBookPart = '', currentPrefix = '';

    document.addEventListener('DOMContentLoaded', () => {
      try {
        initializeTool();
      } catch (err) {
        document.getElementById('container').innerHTML = `<h1>เกิดข้อผิดพลาด</h1><p>${err.message}</p>`;
      }
    });

    function initializeTool() {
      const container = document.getElementById('container');
      const params = new URLSearchParams(window.location.search);
      currentBookName = decodeURIComponent(params.get('bookName') || '');
      currentBookPart = decodeURIComponent(params.get('bookPart') || '');
      currentPrefix = decodeURIComponent(params.get('prefix') || '');

      if (!currentBookName || !currentPrefix) {
        container.innerHTML = `
          <h1>ข้อผิดพลาด</h1>
          <p style="color: red;">ไม่พบคัมภีร์หรือรหัส prefix ที่ระบุใน URL</p>
          <p><a href="index.html"><button>กลับหน้าหลัก</button></a></p>
        `;
        return;
      }

      const savedUserName = localStorage.getItem('paliToolUserName') || '';

      container.innerHTML = `
        <h1>${currentBookName}</h1>
        <p>${currentBookPart ? currentBookPart + ' (' + currentPrefix + ')' : '(Prefix: ' + currentPrefix + ')'}</p>

        <div class="section">
          <label>ชื่อผู้ใช้งาน</label>
          <input type="text" id="user_name" value="${savedUserName}" placeholder="กรอกชื่อของคุณ">

          <label>วรรค/บท</label>
          <input type="text" id="chapter_name" placeholder="วรรค/บท">

          <label>ชื่อเรื่อง</label>
          <input type="text" id="story_name" onblur="checkLastParagraph()">
          <div id="paragraph_suggestion" style="font-size: 0.9em; color: #888; margin-bottom: 10px;"></div>

          <label>ชื่อตอน</label>
          <input type="text" id="section_name" placeholder="ชื่อตอน">

          <label>สถานะ</label>
          <select id="display_flag">
            <option value="2" selected>2 - พร้อมใช้</option>
            <option value="1">1 - รอตรวจ</option>
            <option value="0">0 - ร่าง</option>
          </select>
        </div>

        <div class="section">
          <label>Group ID</label>
          <input type="number" id="master_group_id" placeholder="Group ID">

          <label>หน้าเริ่ม</label>
          <input type="number" id="master_page_start">

          <label>หน้าจบ</label>
          <input type="number" id="master_page_end">

          <label>ย่อหน้า</label>
          <input type="number" id="master_paragraph_num">
        </div>

        <div class="section">
          <label>เนื้อหาบาลี</label>
          <textarea id="pali_input" rows="6" placeholder="วางเนื้อหาบาลีที่นี่"></textarea>
          <button onclick="generateTable()">แบ่งประโยคและแสดงตาราง</button>
        </div>

        <div class="section">
          <table id="create-sentence-table"></table>
        </div>

        <div class="section">
          <button onclick="saveData()">บันทึกข้อมูล</button>
          <div id="status-message"></div>
        </div>
      `;

      document.getElementById('user_name').addEventListener('input', (e) => {
        localStorage.setItem('paliToolUserName', e.target.value);
      });
    }

    window.checkLastParagraph = async function () {
      const paraSuggestionEl = document.getElementById('paragraph_suggestion');
      try {
        const story = document.getElementById('story_name')?.value.trim();
        if (!story) return;
        paraSuggestionEl.textContent = 'กำลังตรวจสอบ...';
        const q = query(paliCollection,
          where("book_title", "==", currentBookName),
          where("book_part", "==", currentBookPart),
          where("story_name", "==", story),
          orderBy("paragraph_num", "desc"),
          limit(1));
        const querySnapshot = await getDocs(q);
        let lastParagraph = 0;
        if (!querySnapshot.empty) {
          lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0;
        }
        document.getElementById('master_paragraph_num').value = lastParagraph + 1;
        paraSuggestionEl.textContent = `เรื่องนี้มีย่อหน้าล่าสุดคือ ${lastParagraph}`;
      } catch (error) {
        document.getElementById('master_paragraph_num').value = 1;
        if (error.code === 'failed-precondition') {
          paraSuggestionEl.innerHTML = `จำเป็นต้อง <a href='https://console.firebase.google.com/u/0/project/pali-exam-builder/firestore/indexes' target='_blank'>สร้าง Index</a>`;
        } else {
          paraSuggestionEl.textContent = 'เป็นเรื่องใหม่';
        }
      }
    }

    window.generateTable = async function () {
      const input = document.getElementById('pali_input').value.trim();
      const table = document.getElementById('create-sentence-table');
      if (!input) return alert('กรุณาใส่เนื้อหาบาลี');
      table.innerHTML = '<thead><tr><th>ประโยค</th><th>ประเภท</th></tr></thead><tbody></tbody>';
      const tbody = table.querySelector('tbody');
      input.split('\n').filter(Boolean).forEach(line => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td><textarea class="pali-text-input" rows="2">${line.trim()}</textarea></td>
          <td>
            <select class="text-type-input">
              <option value="ร้อยแก้ว">ร้อยแก้ว</option>
              <option value="ร้อยกรอง">ร้อยกรอง</option>
            </select>
          </td>`;
      });
    }

    window.saveData = async function () {
      const statusEl = document.getElementById('status-message');
      const userName = document.getElementById('user_name')?.value.trim();
      if (!userName) return alert('กรุณาใส่ชื่อผู้ใช้งาน');
      try {
        statusEl.textContent = 'กำลังบันทึก...';
        const batch = writeBatch(db);
        const chapterName = document.getElementById('chapter_name').value.trim();
        const storyName = document.getElementById('story_name').value.trim();
        const sectionName = document.getElementById('section_name').value.trim();
        const displayFlag = parseInt(document.getElementById('display_flag').value);
        const groupId = document.getElementById('master_group_id').value;
        const pageStart = parseInt(document.getElementById('master_page_start').value) || 0;
        const pageEnd = parseInt(document.getElementById('master_page_end').value) || 0;
        const paragraphNum = parseInt(document.getElementById('master_paragraph_num').value) || 0;
        const rows = document.querySelectorAll('#create-sentence-table tbody tr');

        const q = query(paliCollection, orderBy("id", "desc"), limit(1));
        const latest = await getDocs(q);
        let nextId = latest.empty ? 1 : (latest.docs[0].data().id + 1);

        rows.forEach((row, index) => {
          const docId = nextId + index;
          const fullGroupId = `${currentPrefix}-${groupId}`;
          const docRef = doc(db, "pali_sentences", docId.toString());
          batch.set(docRef, {
            id: docId,
            sentence_group_id: fullGroupId,
            pali_order: index + 1,
            book_title: currentBookName,
            book_part: currentBookPart,
            chapter_name: chapterName,
            story_name: storyName,
            section_name: sectionName,
            display_flag: displayFlag,
            page_start: pageStart,
            page_end: pageEnd,
            paragraph_num: paragraphNum,
            text_type: row.querySelector('.text-type-input').value,
            pali_text: row.querySelector('.pali-text-input').value.trim(),
            user_name_pali: userName,
            timestamp_pali: serverTimestamp(),
            thai_text: "",
            thai_order: 0,
            user_name_thai: "",
            timestamp_thai: null,
            translation_status: 'untranslated'
          });
        });

        await batch.commit();
        statusEl.textContent = '✅ บันทึกข้อมูลสำเร็จ';
        statusEl.className = 'success';
      } catch (error) {
        statusEl.textContent = `❌ บันทึกไม่สำเร็จ: ${error.message}`;
        statusEl.className = 'error';
      }
    }
  </script>
</body>
</html>
