<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือข้อมูลบาลี (Firestore Version)</title>
    <!-- (CSS Style เหมือนเดิม) -->
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: #fff; padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin: 0; }
        fieldset { border: 1px solid #bdc3c7; border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: #34495e; padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: end;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: #3498db; color: #fff; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { background: #2980b9; }
        button.secondary { background-color: #95a5a6; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .table-wrapper { margin-top: 20px; overflow-x: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; min-width: 1700px; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #ecf0f1; position: sticky; top: 0; z-index: 1; text-align: center; }
        #status-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; word-break: break-word; }
        #status-message.success { color: #155724; background-color: #d4edda; }
        #status-message.error { color: #721c24; background-color: #f8d7da; }
        .suggestion-text { font-size: 0.9em; color: #555; margin-top: 5px; min-height: 1.2em; }
        .placeholder { text-align: center; color: #777; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1 id="main-header" style="border-bottom: none;">กำลังโหลด...</h1>
            <a href="index.html" style="text-decoration: none;"><button class="secondary">กลับไปหน้าเลือกคัมภีร์</button></a>
        </div>

        <div id="main-content" class="hidden-section">
            <fieldset> <legend>ข้อมูลผู้ใช้งาน</legend> <input type="text" id="user_name" placeholder="ใส่ชื่อของคุณที่นี่" required> </fieldset>
            <fieldset id="fetch-section"> <legend>ดึงข้อมูลมาแก้ไข</legend> <div class="form-grid"> <input type="number" id="fetch-group-id" placeholder="ใส่ รหัสกลุ่มเนื้อหา (group_id)"> <button id="fetch-btn">ดึงข้อมูล</button> </div> </fieldset>
            
            <div id="create-mode-container">
                <fieldset><legend>ข้อมูลกำกับ</legend>
                    <div class="form-grid">
                        <input type="text" id="chapter_name" placeholder="วรรค/บท">
                        <input type="text" id="story_name" placeholder="ชื่อเรื่อง">
                        <input type="text" id="section_name" placeholder="ชื่อตอน">
                        <select id="display_flag" required> <option value="2" selected>2 - พร้อมใช้</option> <option value="1">1 - รอตรวจ</option> <option value="0">0 - ร่าง</option> </select>
                    </div>
                </fieldset>
                <fieldset><legend>ข้อมูล Group ID, หน้า, และย่อหน้า</legend>
                    <div class="form-grid">
                        <div> <label for="master_group_id">Group ID</label> <div style="display: flex; gap: 10px;"> <input type="number" id="master_group_id" placeholder="ใส่ ID เริ่มต้น"> <button id="find_last_group_id_btn" style="width: auto; white-space: nowrap; flex-shrink: 0;">ค้นหา ID ล่าสุด</button> </div> </div>
                        <div> <label for="master_page_start">หน้าเริ่ม</label> <input type="number" id="master_page_start"> </div>
                        <div> <label for="master_page_end">หน้าจบ</label> <input type="number" id="master_page_end"> </div>
                        <div> <label for="master_paragraph_num">ย่อหน้า</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div>
                    </div>
                </fieldset>
                <fieldset><legend>วางเนื้อหาบาลี</legend><textarea id="pali-input" rows="8"></textarea><button id="split-btn" style="margin-top:10px;">กดเพื่อแบ่งประโยค</button></fieldset>
            </div>
            <fieldset><legend>ตารางข้อมูล</legend><div class="table-wrapper"><table id="sentence-table"><thead id="sentence-thead"></thead><tbody id="sentence-tbody"></tbody></table></div><p id="sentence-placeholder" class="placeholder">ข้อมูลจะปรากฏที่นี่</p></fieldset>
            <fieldset><legend>บันทึกข้อมูล</legend><button id="save-btn" disabled>บันทึกข้อมูล</button><div id="status-message"></div></fieldset>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
        // --- ใส่ firebaseConfig ของคุณที่นี่ ---
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          projectId: "pali-exam-builder",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '';

        document.addEventListener('DOMContentLoaded', () => {
            const createHeader = `<tr><th>ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr>`;
            const editHeader = `<tr><th>ลำดับบาลี</th><th>เนื้อหาบาลี</th><th>ลำดับแปลไทย</th><th>เนื้อหาคำแปลไทย</th></tr>`;

            const mainContent = document.getElementById('main-content');
            const storyNameInput = document.getElementById('story_name');
            const saveBtn = document.getElementById('save-btn');
            const sentenceTbody = document.getElementById('sentence-tbody');
            const sentencePlaceholder = document.getElementById('sentence-placeholder');
            const statusMessage = document.getElementById('status-message');
            const userNameInput = document.getElementById('user_name');
            
            function initializeTool() {
                const params = new URLSearchParams(window.location.search);
                currentBookName = decodeURIComponent(params.get('bookName') || '');
                currentBookPart = decodeURIComponent(params.get('bookPart') || '');
                if (!currentBookName) {
                    document.getElementById('main-header').textContent = 'ข้อผิดพลาด';
                    mainContent.innerHTML = '<p style="text-align:center; color:red;">ไม่พบคัมภีร์ที่เลือก กรุณากลับไปที่หน้าแรก</p>';
                    return;
                }
                document.getElementById('main-header').textContent = `กำลังทำงานกับ: ${currentBookName}` + (currentBookPart ? ` - ${currentBookPart}` : '');
                const savedUserName = localStorage.getItem('paliToolUserName');
                if (savedUserName) { userNameInput.value = savedUserName; }
                userNameInput.addEventListener('input', () => { localStorage.setItem('paliToolUserName', userNameInput.value); });
                mainContent.classList.remove('hidden-section');
                document.getElementById('create-mode-container').style.display = 'block';
                document.getElementById('sentence-thead').innerHTML = createHeader;
            }

            document.getElementById('find_last_group_id_btn').addEventListener('click', findLastGroupId);
            document.getElementById('split-btn').addEventListener('click', generateCreateTable);
            document.getElementById('fetch-btn').addEventListener('click', fetchDataForEdit);
            document.getElementById('save-btn').addEventListener('click', saveData);

            function updateStatus(message, type) { statusMessage.textContent = message; statusMessage.className = type; }

            async function findLastId(field, bookFilter = true) {
                updateStatus(`กำลังค้นหา ${field} ล่าสุด...`, 'loading');
                let q;
                if (bookFilter) {
                    q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), orderBy(field, "desc"), limit(1));
                } else {
                    q = query(paliCollection, orderBy(field, "desc"), limit(1));
                }
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return 0;
                return querySnapshot.docs[0].data()[field] || 0;
            }

            async function findLastGroupId() {
                try {
                    const lastGroupId = await findLastId("sentence_group_id");
                    document.getElementById('master_group_id').value = lastGroupId + 1;
                    updateStatus(`พบ Group ID ล่าสุดในคัมภีร์นี้คือ ${lastGroupId}`, 'success');
                } catch(error) { updateStatus(`เกิดข้อผิดพลาด: ${error.message}`, 'error'); }
            }
            
            async function generateCreateTable() {
                const paliInput = document.getElementById('pali-input');
                if (!paliInput.value.trim()) { alert('กรุณาวางเนื้อหาบาลีก่อน'); return; }
                const masterGroupId = document.getElementById('master_group_id').value;
                if (!masterGroupId) { alert('กรุณาใส่ Group ID'); return; }

                try {
                    const nextId = await findLastId("id", false) + 1; // ID ต้องไม่ซ้ำกันทั้งระบบ
                    const masterPageStart = document.getElementById('master_page_start').value;
                    const masterPageEnd = document.getElementById('master_page_end').value;
                    const masterParagraphNum = document.getElementById('master_paragraph_num').value;
                    
                    document.getElementById('sentence-thead').innerHTML = createHeader;
                    sentenceTbody.innerHTML = '';
                    let validLinesCount = 0;
                    paliInput.value.split(/\r?\n/).forEach((line) => {
                        const cleanedLine = line.trim(); if (cleanedLine.length === 0) return;
                        const row = document.createElement('tr');
                        row.dataset.id = nextId + validLinesCount;
                        row.innerHTML = `<td class="id-cell">${nextId + validLinesCount}</td><td><textarea class="pali-text-input" rows="3">${cleanedLine}</textarea></td><td><input type="number" class="page-start-input" value="${masterPageStart}"></td><td><input type="number" class="page-end-input" value="${masterPageEnd}"></td><td><input type="number" class="paragraph-num-input" value="${masterParagraphNum}"></td><td><select class="text-type-input"><option value="ร้อยแก้ว">ร้อยแก้ว</option><option value="ร้อยกรอง">ร้อยกรอง</option></select></td>`;
                        sentenceTbody.appendChild(row);
                        validLinesCount++;
                    });
                    
                    if (validLinesCount > 0) { sentencePlaceholder.style.display = 'none'; saveBtn.disabled = false; }
                } catch(error) { updateStatus(`เกิดข้อผิดพลาด: ${error.message}`, 'error'); }
            }

            async function saveData() {
                if (!userNameInput.value.trim()) { alert('กรุณาใส่ชื่อผู้ใช้งาน'); return; }
                updateStatus('กำลังบันทึก...', 'loading'); saveBtn.disabled = true;

                try {
                    const batch = writeBatch(db);
                    const masterGroupId = parseInt(document.getElementById('master_group_id').value);
                    const chapterName = document.getElementById('chapter_name').value;
                    const storyName = document.getElementById('story_name').value;
                    const sectionName = document.getElementById('section_name').value;
                    const displayFlag = parseInt(document.getElementById('display_flag').value);

                    Array.from(sentenceTbody.querySelectorAll('tr')).forEach((row, index) => {
                        const docId = row.dataset.id;
                        const docRef = doc(db, "pali_sentences", docId);
                        const dataToSave = {
                            id: parseInt(docId),
                            sentence_group_id: masterGroupId, pali_order: index + 1,
                            book_title: currentBookName, book_part: currentBookPart,
                            chapter_name: chapterName, story_name: storyName, section_name: sectionName,
                            display_flag: displayFlag,
                            page_start: parseInt(row.querySelector('.page-start-input')?.value) || 0,
                            page_end: parseInt(row.querySelector('.page-end-input')?.value) || 0,
                            paragraph_num: parseInt(row.querySelector('.paragraph-num-input')?.value) || 0,
                            text_type: row.querySelector('.text-type-input')?.value,
                            pali_text: row.querySelector('.pali-text-input')?.value.trim(),
                            user_name_pali: userNameInput.value.trim(),
                            timestamp_pali: serverTimestamp(),
                            thai_text: "", thai_order: 0, user_name_thai: "", timestamp_thai: null
                        };
                        batch.set(docRef, dataToSave);
                    });
                    await batch.commit();
                    updateStatus('บันทึกข้อมูลสำเร็จ!', 'success');
                    document.getElementById('pali-input').value = '';
                    sentenceTbody.innerHTML = '';
                    saveBtn.disabled = true;
                } catch (error) { updateStatus(`บันทึกไม่สำเร็จ: ${error.message}`, 'error'); saveBtn.disabled = false; }
            }

            async function fetchDataForEdit() { /* (ฟังก์ชันนี้ยังคงต้องพัฒนาต่อ) */ }
            
            initializeTool();
        });
    </script>
</body>
</html>