<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือข้อมูลบาลี (v2.9 - Complete)</title>
    <!-- (CSS Style เหมือนเดิมทั้งหมด) -->
    <style>
        :root { --primary-color: #3498db; --secondary-color: #95a5a6; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --light-bg: #f0f2f5; --white-bg: #fff; --text-dark: #2c3e50; --text-light: #555; --border-color: #ddd; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 95%; margin: auto; background: var(--white-bg); padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        h1, h2 { color: var(--text-dark); margin-top: 0; }
        h1 { border: none; padding: 0; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 25px; }
        legend { font-weight: 700; font-size: 1.2em; color: var(--text-light); padding: 0 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 20px; align-items: start;}
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Sarabun', sans-serif; }
        button { background: var(--primary-color); color: var(--white-bg); padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; height: 40px; }
        button:hover { filter: brightness(90%); }
        .view { display: none; }
        .view.active { display: block; }
        .suggestion-text { font-size: 0.9em; color: var(--text-light); margin-top: 5px; min-height: 1.2em; }
        .suggestion-text.error { color: var(--danger-color); font-weight: bold; }
        .suggestion-text.success { color: var(--success-color); font-weight: bold; }
        .suggestion-text.warning { color: var(--warning-color); font-weight: bold; }
        #edit-view-content { display: none; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        #pali-display-panel { background-color: #fafafa; padding: 15px; border-radius: 5px; border: 1px solid #eee; height: fit-content; position: sticky; top: 20px; }
        #pali-display-panel h3 { margin-top: 0; }
        #pali-display-panel p { margin: 0 0 1em 0; padding: 0.5em; border-bottom: 1px dotted #ccc; transition: background-color 0.3s; }
        #pali-display-panel p.highlight { background-color: #fff8e1; }
        #group-results div { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #group-results div:hover { background-color: #f0f8ff; }
        .edit-buttons { display: flex; align-items: center; gap: 8px; }
        .edit-buttons button { padding: 5px 10px; height: auto; font-size: 14px; }
        .status-badge { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; color: #fff; }
        .status-untranslated { background-color: var(--danger-color); }
        .status-completed { background-color: var(--success-color); }
    </style>
</head>
<body>
    <div class="container" id="container">
        <!-- Header and View Switcher -->
        <div class="header-bar">
            <div><h1 id="main-header">กำลังโหลด...</h1><p id="sub-header"></p></div>
            <div id="view-switcher">
                <a href="index.html"><button class="secondary">กลับไปหน้าสารบัญ</button></a>
                <button id="go_to_edit_view_btn" class="success">ไปหน้าแก้ไข</button>
                <button id="go_to_create_view_btn" class="secondary" style="display: none;">กลับไปหน้าสร้างข้อมูล</button>
            </div>
        </div>

        <!-- Create View -->
        <div id="create-view" class="view">
            <h2 id="create-view-header">หน้าเครื่องมือ (สร้างข้อมูลบาลี)</h2>
            <fieldset> <legend>ข้อมูลผู้ใช้งาน</legend> <input type="text" id="user_name" placeholder="ใส่ชื่อของคุณที่นี่" required> </fieldset>
            <fieldset><legend>ข้อมูลกำกับ</legend>
                <div class="form-grid">
                    <input type="text" id="chapter_name" placeholder="วรรค/บท">
                    <input type="text" id="story_name" placeholder="ชื่อเรื่อง">
                    <input type="text" id="section_name" placeholder="ชื่อตอน">
                    <select id="display_flag" required> <option value="2" selected>2 - พร้อมใช้</option> <option value="1">1 - รอตรวจ</option> <option value="0">0 - ร่าง</option> </select>
                </div>
            </fieldset>
            <fieldset><legend>ข้อมูล Group ID, หน้า, และย่อหน้า (ต้องกรอก*)</legend>
                <div class="form-grid">
                    <div> <label for="master_group_id">Group ID (ตัวเลขเท่านั้น)*</label> <input type="number" id="master_group_id" placeholder="ใส่ ID เริ่มต้น"> <p id="group_id_suggestion" class="suggestion-text"></p></div>
                    <div> <label for="master_page_start">หน้าเริ่ม*</label> <input type="number" id="master_page_start"> <p id="page_check_result" class="suggestion-text"></p> </div>
                    <div> <label for="master_page_end">หน้าจบ</label> <input type="number" id="master_page_end"> </div>
                    <div> <label for="master_paragraph_num">ย่อหน้า*</label> <input type="number" id="master_paragraph_num"> <p id="paragraph_suggestion" class="suggestion-text"></p> </div>
                </div>
            </fieldset>
            <fieldset><legend>วางเนื้อหาบาลี</legend>
                <textarea id="pali-input" rows="8"></textarea>
                <p id="hash_check_result" class="suggestion-text"></p>
                <button id="split-btn" style="margin-top:10px;">กดเพื่อแบ่งประโยค</button>
            </fieldset>
            <div id="create-data-work-area" style="display: none;">
                <fieldset><legend>ตารางสร้างข้อมูล</legend><div class="table-wrapper"><table id="create-sentence-table" style="width:100%"></table></div></fieldset>
                <fieldset><legend>บันทึกข้อมูล</legend><button id="create-save-btn">บันทึกข้อมูลใหม่</button><div id="create-status-message" class="status-message"></div></fieldset>
            </div>
        </div>

        <!-- Edit View -->
        <div id="edit-view" class="view">
             <h2>หน้าแก้ไข</h2>
            <fieldset id="edit-mode-selector">
                <legend>ค้นหากลุ่มข้อมูลเพื่อแก้ไข</legend>
                <div class="form-grid">
                    <input type="text" id="search_story_name" list="story_name_datalist_for_search" placeholder="เลือก/พิมพ์ชื่อเรื่อง">
                    <datalist id="story_name_datalist_for_search"></datalist>
                    <input type="number" id="search_page_num" placeholder="ใส่เลขหน้า">
                    <button id="search_groups_btn">ค้นหากลุ่ม</button>
                </div>
                <div id="group-results" style="margin-top: 15px;"></div>
            </fieldset>
            <div id="edit-view-content" style="display: none;">
                <div id="pali-display-panel">
                    <h3 id="pali-display-header">เนื้อหาบาลี (สำหรับอ้างอิง)</h3>
                    <div id="pali-display-text"></div>
                </div>
                <div id="translation-panel">
                    <h3>ตารางแก้ไขคำแปล</h3>
                    <div class="table-wrapper"><table id="edit-sentence-table" style="width:100%"></table></div>
                    <fieldset><legend>บันทึกการแก้ไข</legend><button id="edit-save-btn">อัปเดตคำแปล</button><div id="edit-status-message" class="status-message"></div></fieldset>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          projectId: "pali-exam-builder",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const paliCollection = collection(db, "pali_sentences");
        
        let currentBookName = '', currentBookPart = '', currentPrefix = '';
        let currentMode = 'create';

        document.addEventListener('DOMContentLoaded', () => {
            const createHeader = `<thead><tr><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr></thead><tbody></tbody>`;
            const editHeader = `<thead><tr><th>ID</th><th>ลำดับบาลี</th><th>เนื้อหาบาลี</th><th>ลำดับแปลไทย</th><th>เนื้อหาคำแปลไทย</th></tr></thead><tbody></tbody>`;

            const createView = document.getElementById('create-view'), editView = document.getElementById('edit-view');
            const goToEditBtn = document.getElementById('go_to_edit_view_btn'), goToCreateBtn = document.getElementById('go_to_create_view_btn');
            const storyNameInput = document.getElementById('story_name'), masterPageStartInput = document.getElementById('master_page_start'), paliInput = document.getElementById('pali-input');

            function switchView(viewToShow) {
                createView.classList.toggle('active', viewToShow === 'create');
                editView.classList.toggle('active', viewToShow === 'edit');
                goToEditBtn.style.display = viewToShow === 'create' ? 'inline-block' : 'none';
                goToCreateBtn.style.display = viewToShow === 'edit' ? 'inline-block' : 'none';
                document.getElementById('edit-view-content').style.display = 'none';
                resetCreateForm(false); // ไม่เคลียร์ฟอร์มทั้งหมด แค่ซ่อนตาราง
            }

            function initializeTool() {
                // (โค้ดเหมือนเดิม)
            }

            // --- Event Listeners ---
            goToEditBtn.addEventListener('click', () => switchView('edit'));
            goToCreateBtn.addEventListener('click', () => { switchView('create'); resetCreateForm(true); });
            storyNameInput.addEventListener('blur', async () => { await checkLastParagraph(); await findLastGroupId(); });
            masterPageStartInput.addEventListener('blur', checkPageExists);
            paliInput.addEventListener('blur', checkFirstSentenceHash);
            document.getElementById('split-btn').addEventListener('click', generateCreateTable);
            document.getElementById('create-save-btn').addEventListener('click', () => saveData(currentMode));
            document.getElementById('search_groups_btn').addEventListener('click', searchGroupsToEdit);
            document.getElementById('edit-save-btn').addEventListener('click', () => saveData('translate'));
            
            function updateStatus(elementId, message, type) { /* ... */ }
            async function findLastId(field) { /* ... */ }
            async function findLastGroupId() { /* ... */ }
            
            async function checkLastParagraph() {
                const paraSuggestionEl = document.getElementById('paragraph_suggestion');
                if (!storyNameInput.value.trim()) { paraSuggestionEl.textContent = ''; return; }
                paraSuggestionEl.textContent = 'กำลังตรวจสอบ...';
                try {
                    const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("story_name", "==", storyNameInput.value.trim()), orderBy("paragraph_num", "desc"), limit(1));
                    const querySnapshot = await getDocs(q);
                    let lastParagraph = 0;
                    if (!querySnapshot.empty) { lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0; }
                    updateStatus('paragraph_suggestion', `เรื่องนี้มีย่อหน้าล่าสุดคือ ${lastParagraph}. แนะนำให้ใช้: ${lastParagraph + 1}`, 'success');
                } catch (error) { updateStatus('paragraph_suggestion', 'เป็นเรื่องใหม่ (ต้องสร้าง Index เพื่อยืนยัน)', 'warning'); }
            }

            function resetCreateForm(fullReset) {
                document.getElementById('create-data-work-area').style.display = 'none';
                document.getElementById('create-save-btn').disabled = true;
                if (fullReset) {
                    const fieldsToClear = ['chapter_name', 'story_name', 'section_name', 'master_group_id', 'master_page_start', 'master_page_end', 'master_paragraph_num', 'pali-input'];
                    fieldsToClear.forEach(id => document.getElementById(id).value = '');
                    const suggestionsToClear = ['group_id_suggestion', 'page_check_result', 'paragraph_suggestion', 'hash_check_result'];
                    suggestionsToClear.forEach(id => document.getElementById(id).textContent = '');
                }
            }

            async function generateCreateTable(dataToPopulate = null) {
                const masterGroupId = document.getElementById('master_group_id').value;
                const masterPageStart = masterPageStartInput.value;
                const masterParagraphNum = document.getElementById('master_paragraph_num').value;
                if (!paliInput.value.trim() || !masterGroupId || !masterPageStart || !masterParagraphNum) {
                    alert('กรุณากรอกข้อมูลสำคัญให้ครบถ้วน:\n- Group ID\n- หน้าเริ่ม\n- ย่อหน้า\n- เนื้อหาบาลี');
                    return;
                }
                document.getElementById('create-data-work-area').style.display = 'block';
                const table = document.getElementById('create-sentence-table');
                table.innerHTML = `<thead><tr><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                try {
                    const nextId = await findLastId("id") + 1;
                    const masterPageEnd = document.getElementById('master_page_end').value;
                    let validLinesCount = 0;
                    const sourceLines = dataToPopulate ? dataToPopulate.map(d => d.pali_text) : paliInput.value.split(/\r?\n/);
                    
                    sourceLines.forEach((line, index) => {
                        const cleanedLine = line.trim(); if (cleanedLine.length === 0) return;
                        const row = tbody.insertRow();
                        const docData = dataToPopulate ? dataToPopulate[index] : null;
                        row.dataset.id = docData ? docData.id : nextId + index;
                        row.innerHTML = `<td class="id-cell">${row.dataset.id}</td><td><input type="number" class="group-id-input" value="${docData ? docData.sentence_group_id.split('-').pop() : masterGroupId}"></td><td><textarea class="pali-text-input" rows="3">${cleanedLine}</textarea></td><td><input type="number" class="page-start-input" value="${docData ? docData.page_start : masterPageStart}"></td><td><input type="number" class="page-end-input" value="${docData ? docData.page_end : masterPageEnd}"></td><td><input type="number" class="paragraph-num-input" value="${docData ? docData.paragraph_num : masterParagraphNum}"></td><td><select class="text-type-input"><option value="ร้อยแก้ว" ${docData && docData.text_type === 'ร้อยแก้ว' ? 'selected' : ''}>ร้อยแก้ว</option><option value="ร้อยกรอง" ${docData && docData.text_type === 'ร้อยกรอง' ? 'selected' : ''}>ร้อยกรอง</option></select></td>`;
                        validLinesCount++;
                    });
                    if (validLinesCount > 0) { document.getElementById('create-save-btn').disabled = false; }
                } catch(error) { updateStatus('create-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); }
            }

            async function saveData(mode) {
                const statusElId = mode === 'create' || mode === 'super-edit' ? 'create-status-message' : 'edit-status-message';
                const saveBtnId = mode === 'create' || mode === 'super-edit' ? 'create-save-btn' : 'edit-save-btn';
                if (!userNameInput.value.trim()) { alert('กรุณาใส่ชื่อผู้ใช้งาน'); return; }
                updateStatus(statusElId, 'กำลังบันทึก...', 'loading');
                document.getElementById(saveBtnId).disabled = true;
                
                try {
                    const batch = writeBatch(db);
                    if (mode === 'create' || mode === 'super-edit') {
                        const chapterName = document.getElementById('chapter_name').value, storyName = storyNameInput.value, sectionName = document.getElementById('section_name').value;
                        const displayFlag = parseInt(document.getElementById('display_flag').value);
                        
                        Array.from(document.getElementById('create-sentence-table').querySelector('tbody').rows).forEach((row, index) => {
                            const docId = row.dataset.id;
                            const groupIdNum = row.querySelector('.group-id-input')?.value || '0';
                            const fullGroupId = `${currentPrefix}-${groupIdNum}`;
                            const docRef = doc(db, "pali_sentences", docId);
                            let dataToSave = {
                                id: parseInt(docId), sentence_group_id: fullGroupId, pali_order: index + 1,
                                book_title: currentBookName, book_part: currentBookPart, chapter_name: chapterName, story_name: storyName, section_name: sectionName,
                                display_flag: displayFlag, page_start: parseInt(row.querySelector('.page-start-input')?.value) || 0,
                                page_end: parseInt(row.querySelector('.page-end-input')?.value) || 0, paragraph_num: parseInt(row.querySelector('.paragraph-num-input')?.value) || 0,
                                text_type: row.querySelector('.text-type-input')?.value, pali_text: row.querySelector('.pali-text-input')?.value.trim(),
                                user_name_pali: userNameInput.value.trim(), timestamp_pali: serverTimestamp(),
                            };
                            if (mode === 'create') {
                                Object.assign(dataToSave, { thai_text: "", thai_order: 0, user_name_thai: "", timestamp_thai: null, translation_status: 'untranslated', first_sentence_hash: null });
                            }
                            batch.set(docRef, dataToSave, { merge: true }); // Use merge:true for super-edit
                        });
                    } else { // translate mode
                         Array.from(document.getElementById('edit-sentence-table').querySelector('tbody').rows).forEach(row => {
                            const docId = row.dataset.id;
                            const docRef = doc(db, "pali_sentences", docId);
                            batch.update(docRef, {
                                thai_text: row.querySelector('.thai-text-input')?.value.trim() || '',
                                thai_order: parseInt(row.querySelector('.thai-order-input')?.value) || 0,
                                user_name_thai: userNameInput.value.trim(), timestamp_thai: serverTimestamp(), translation_status: 'completed'
                            });
                        });
                    }
                    await batch.commit();
                    updateStatus(statusElId, 'บันทึกข้อมูลสำเร็จ!', 'success');
                    if (mode === 'create' || mode === 'super-edit') { resetCreateForm(true); } 
                    else { document.getElementById('edit-view-content').style.display = 'none'; }
                } catch (error) { updateStatus(statusElId, `บันทึกไม่สำเร็จ: ${error.message}`, 'error'); document.getElementById(saveBtnId).disabled = false; }
            }
            
            async function searchGroupsToEdit() {
                // (โค้ดเหมือนเดิม แต่เพิ่มปุ่มแก้ไขข้อมูลหลัก)
                groups.forEach((data, groupId) => {
                    const div = document.createElement('div');
                    const statusClass = `status-${data.status}`;
                    div.innerHTML = `<span>Group ID: ${groupId} (ตัวอย่าง: ${data.pali_text})</span> 
                                     <div class="edit-buttons">
                                        <span class="status-badge ${statusClass}">${data.status}</span>
                                        <button class="secondary" data-group-id="${groupId}" data-mode="super-edit">✏️ แก้ไขหลัก</button>
                                        <button class="success" data-group-id="${groupId}" data-mode="translate">แปลไทย</button>
                                     </div>`;
                    div.querySelector('[data-mode="super-edit"]').addEventListener('click', (e) => { e.stopPropagation(); fetchDataForFullEdit(groupId); });
                    div.querySelector('[data-mode="translate"]').addEventListener('click', (e) => { e.stopPropagation(); fetchDataForTranslate(groupId); });
                    groupResultsDiv.appendChild(div);
                });
            }

            async function fetchDataForFullEdit(groupId) {
                updateStatus('edit-status-message', `กำลังดึงข้อมูล Group ID: ${groupId} เพื่อแก้ไขหลัก...`, 'loading');
                try {
                    const q = query(paliCollection, where("sentence_group_id", "==", groupId), orderBy("pali_order"));
                    const querySnapshot = await getDocs(q);
                    const data = querySnapshot.docs.map(doc => doc.data());
                    if(data.length > 0) {
                        populateCreateFormWithData(data);
                    } else { throw new Error('ไม่พบข้อมูล'); }
                } catch (error) { updateStatus('edit-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); }
            }

            function populateCreateFormWithData(data) {
                switchView('create');
                currentMode = 'super-edit';
                document.getElementById('create-view-header').textContent = `โหมดแก้ไขข้อมูลหลัก (Group: ${data[0].sentence_group_id})`;
                document.getElementById('create-save-btn').textContent = 'อัปเดตข้อมูลหลัก';

                document.getElementById('chapter_name').value = data[0].chapter_name || '';
                document.getElementById('story_name').value = data[0].story_name || '';
                document.getElementById('section_name').value = data[0].section_name || '';
                document.getElementById('display_flag').value = data[0].display_flag || '2';
                document.getElementById('master_group_id').value = data[0].sentence_group_id.split('-').pop() || '';
                document.getElementById('master_page_start').value = data[0].page_start || '';
                document.getElementById('master_page_end').value = data[0].page_end || '';
                document.getElementById('master_paragraph_num').value = data[0].paragraph_num || '';
                
                const combinedPaliText = data.map(d => d.pali_text).join('\n');
                paliInput.value = combinedPaliText;
                
                generateCreateTable(data); // ส่งข้อมูลไปสร้างตารางที่แก้ไขได้
            }

            // (ฟังก์ชันที่เหลือเหมือนเดิม)
            
            initializeTool();
        });
    </script>
</body>
</html>