<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    // --- ใส่ firebaseConfig ของคุณที่นี่ ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "pali-exam-builder",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const paliCollection = collection(db, "pali_sentences");
    
    let currentBookName = '', currentBookPart = '', currentPrefix = '';
    let currentMode = 'create';

    document.addEventListener('DOMContentLoaded', () => {
        const createHeader = `<thead><tr><th>ID</th><th>Group ID</th><th>เนื้อหาบาลี</th><th>หน้าเริ่ม</th><th>หน้าจบ</th><th>ย่อหน้า</th><th>ประเภท</th></tr></thead><tbody></tbody>`;
        const editHeader = `<thead><tr><th>ID</th><th>ลำดับบาลี</th><th>เนื้อหาบาลี</th><th>ลำดับแปลไทย</th><th>เนื้อหาคำแปลไทย</th></tr></thead><tbody></tbody>`;

        // --- Cache DOM elements ---
        const container = document.getElementById('container');
        const mainHeader = document.getElementById('main-header');
        const subHeader = document.getElementById('sub-header');
        const createView = document.getElementById('create-view');
        const editView = document.getElementById('edit-view');
        const goToEditBtn = document.getElementById('go_to_edit_view_btn');
        const goToCreateBtn = document.getElementById('go_to_create_view_btn');
        const dataWorkArea = document.getElementById('data-work-area');
        const createDataWorkArea = document.getElementById('create-data-work-area');
        const editViewContent = document.getElementById('edit-view-content');
        const createSentenceTable = document.getElementById('create-sentence-table');
        const editSentenceTable = document.getElementById('edit-sentence-table');
        const createSaveBtn = document.getElementById('create-save-btn');
        const editSaveBtn = document.getElementById('edit-save-btn');
        const userNameInput = document.getElementById('user_name');
        const storyNameInput = document.getElementById('story_name');

        function switchView(viewToShow) {
            currentMode = viewToShow;
            createView.classList.toggle('active', viewToShow === 'create');
            editView.classList.toggle('active', viewToShow === 'edit');
            goToEditBtn.style.display = viewToShow === 'create' ? 'inline-block' : 'none';
            goToCreateBtn.style.display = viewToShow === 'edit' ? 'inline-block' : 'none';
            
            // ซ่อนพื้นที่ทำงานและเคลียร์ข้อมูลเก่าเสมอเมื่อสลับหน้า
            createDataWorkArea.style.display = 'none';
            editViewContent.style.display = 'none';
            createSentenceTable.innerHTML = '';
            editSentenceTable.innerHTML = '';
            updateStatus('create-status-message', '', '');
            updateStatus('edit-status-message', '', '');
        }

        function initializeTool() {
            const params = new URLSearchParams(window.location.search);
            currentBookName = decodeURIComponent(params.get('bookName') || '');
            currentBookPart = decodeURIComponent(params.get('bookPart') || '');
            currentPrefix = decodeURIComponent(params.get('prefix') || '');

            if (!currentBookName || !currentPrefix) {
                mainHeader.textContent = 'ข้อผิดพลาด';
                container.innerHTML = `<div class="header-bar"><h1>ข้อผิดพลาด</h1></div><p style="text-align:center; color:red;">ไม่พบคัมภีร์หรือ Prefix ที่เลือกใน URL<br>กรุณากลับไปที่หน้าแรกแล้วเลือกคัมภีร์อีกครั้ง</p><br><p style="text-align:center;"><a href="index.html"><button>กลับไปหน้าแรก</button></a></p>`;
                return;
            }
            
            mainHeader.textContent = `${currentBookName}`;
            subHeader.textContent = currentBookPart ? `${currentBookPart} (Prefix: ${currentPrefix})` : `(Prefix: ${currentPrefix})`;
            
            const savedUserName = localStorage.getItem('paliToolUserName');
            if (savedUserName) { userNameInput.value = savedUserName; }
            userNameInput.addEventListener('input', () => { localStorage.setItem('paliToolUserName', userNameInput.value); });
            
            switchView('create');
            populateStoryDatalistForSearch();
        }

        // --- Event Listeners ---
        goToEditBtn.addEventListener('click', () => switchView('edit'));
        goToCreateBtn.addEventListener('click', () => switchView('create'));
        storyNameInput.addEventListener('blur', checkLastParagraph);
        document.getElementById('find_last_group_id_btn').addEventListener('click', findLastGroupId);
        document.getElementById('split-btn').addEventListener('click', generateCreateTable);
        createSaveBtn.addEventListener('click', () => saveData('create'));
        document.getElementById('search_groups_btn').addEventListener('click', searchGroupsToEdit);
        editSaveBtn.addEventListener('click', () => saveData('edit'));
        
        // (ฟังก์ชันอื่นๆ ทั้งหมดเหมือนเดิม ไม่ต้องแก้ไข)
        function updateStatus(elementId, message, type) { /* ... */ }
        async function findLastId(field) { /* ... */ }
        async function findLastGroupId() { /* ... */ }
        async function checkLastParagraph() { /* ... */ }
        async function generateCreateTable() { /* ... */ }
        async function saveData(mode) { /* ... */ }
        async function searchGroupsToEdit() { /* ... */ }
        async function fetchDataForEdit(groupId) { /* ... */ }
        function generateEditTable(data) { /* ... */ }
        async function populateStoryDatalistForSearch(){ /* ... */ }

        // --- นี่คือโค้ดเต็มของฟังก์ชันทั้งหมด (เพื่อความสมบูรณ์) ---
        function updateStatus(elementId, message, type) { const el = document.getElementById(elementId); if(el){ el.textContent = message; el.className = `status-message ${type}`; } }
        async function findLastId(field) { const q = query(paliCollection, orderBy(field, "desc"), limit(1)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) return 0; return querySnapshot.docs[0].data()[field] || 0; }
        async function findLastGroupId() { const statusElId = 'group_id_suggestion'; updateStatus(statusElId, `กำลังค้นหา...`, ''); try { const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), orderBy("sentence_group_id", "desc"), limit(1)); const querySnapshot = await getDocs(q); let lastNumber = 0; if (!querySnapshot.empty) { const lastFullId = querySnapshot.docs[0].data().sentence_group_id; lastNumber = parseInt(lastFullId.toString().split('-').pop()) || 0; } document.getElementById('master_group_id').value = lastNumber + 1; updateStatus(statusElId, `ID ล่าสุดที่พบ: ${currentPrefix}-${lastNumber}. ID ถัดไปคือ ${lastNumber + 1}`, 'success'); } catch (error) { updateStatus(statusElId, `เกิดข้อผิดพลาด: ${error.message}. อาจต้องสร้าง Index`, 'error'); } }
        async function checkLastParagraph() { const paraSuggestionEl = document.getElementById('paragraph_suggestion'); if (!storyNameInput.value.trim()) return; paraSuggestionEl.textContent = 'กำลังตรวจสอบ...'; try { const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), where("story_name", "==", storyNameInput.value.trim()), orderBy("paragraph_num", "desc"), limit(1)); const querySnapshot = await getDocs(q); let lastParagraph = 0; if (!querySnapshot.empty) { lastParagraph = querySnapshot.docs[0].data().paragraph_num || 0; } document.getElementById('master_paragraph_num').value = lastParagraph + 1; paraSuggestionEl.textContent = `เรื่องนี้มีย่อหน้าล่าสุดคือ ${lastParagraph}`; } catch (error) { document.getElementById('master_paragraph_num').value = 1; if (error.code === 'failed-precondition') { paraSuggestionEl.textContent = 'เป็นเรื่องใหม่ (ต้องสร้าง Index เพื่อยืนยัน)'; } else { paraSuggestionEl.textContent = 'เป็นเรื่องใหม่'; } } }
        async function generateCreateTable() { const paliInput = document.getElementById('pali-input'); if (!paliInput.value.trim()) { alert('กรุณาวางเนื้อหาบาลีก่อน'); return; } const masterGroupId = document.getElementById('master_group_id').value; if (!masterGroupId) { alert('กรุณาใส่ Group ID'); return; } createDataWorkArea.style.display = 'block'; const table = createSentenceTable; table.innerHTML = createHeader; const tbody = table.querySelector('tbody'); try { const nextId = await findLastId("id") + 1; const masterPageStart = document.getElementById('master_page_start').value; const masterPageEnd = document.getElementById('master_page_end').value; const masterParagraphNum = document.getElementById('master_paragraph_num').value; let validLinesCount = 0; paliInput.value.split(/\r?\n/).forEach((line, index) => { const cleanedLine = line.trim(); if (cleanedLine.length === 0) return; const row = tbody.insertRow(); row.dataset.id = nextId + index; row.innerHTML = `<td class="id-cell">${nextId + index}</td><td><input type="number" class="group-id-input" value="${masterGroupId}"></td><td><textarea class="pali-text-input" rows="3">${cleanedLine}</textarea></td><td><input type="number" class="page-start-input" value="${masterPageStart}"></td><td><input type="number" class="page-end-input" value="${masterPageEnd}"></td><td><input type="number" class="paragraph-num-input" value="${masterParagraphNum}"></td><td><select class="text-type-input"><option value="ร้อยแก้ว">ร้อยแก้ว</option><option value="ร้อยกรอง">ร้อยกรอง</option></select></td>`; validLinesCount++; }); if (validLinesCount > 0) { createSaveBtn.disabled = false; } } catch(error) { updateStatus('create-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); } }
        async function saveData(mode) { const statusElId = mode === 'create' ? 'create-status-message' : 'edit-status-message'; const saveBtnId = mode === 'create' ? 'create-save-btn' : 'edit-save-btn'; if (!userNameInput.value.trim()) { alert('กรุณาใส่ชื่อผู้ใช้งาน'); return; } updateStatus(statusElId, 'กำลังบันทึก...', 'loading'); document.getElementById(saveBtnId).disabled = true; try { const batch = writeBatch(db); if (mode === 'create') { const chapterName = document.getElementById('chapter_name').value, storyName = storyNameInput.value, sectionName = document.getElementById('section_name').value; const displayFlag = parseInt(document.getElementById('display_flag').value); Array.from(createSentenceTable.querySelector('tbody').rows).forEach((row, index) => { const docId = row.dataset.id; const groupIdNum = row.querySelector('.group-id-input')?.value || '0'; const fullGroupId = `${currentPrefix}-${groupIdNum}`; const docRef = doc(db, "pali_sentences", docId); batch.set(docRef, { id: parseInt(docId), sentence_group_id: fullGroupId, pali_order: index + 1, book_title: currentBookName, book_part: currentBookPart, chapter_name: chapterName, story_name: storyName, section_name: sectionName, display_flag: displayFlag, page_start: parseInt(row.querySelector('.page-start-input')?.value) || 0, page_end: parseInt(row.querySelector('.page-end-input')?.value) || 0, paragraph_num: parseInt(row.querySelector('.paragraph-num-input')?.value) || 0, text_type: row.querySelector('.text-type-input')?.value, pali_text: row.querySelector('.pali-text-input')?.value.trim(), user_name_pali: userNameInput.value.trim(), timestamp_pali: serverTimestamp(), thai_text: "", thai_order: 0, user_name_thai: "", timestamp_thai: null, translation_status: 'untranslated' }); }); } else { Array.from(editSentenceTable.querySelector('tbody').rows).forEach(row => { const docId = row.dataset.id; const docRef = doc(db, "pali_sentences", docId); batch.update(docRef, { thai_text: row.querySelector('.thai-text-input')?.value.trim() || '', thai_order: parseInt(row.querySelector('.thai-order-input')?.value) || 0, user_name_thai: userNameInput.value.trim(), timestamp_thai: serverTimestamp(), translation_status: 'completed' }); }); } await batch.commit(); updateStatus(statusElId, 'บันทึกข้อมูลสำเร็จ!', 'success'); if (mode === 'create') { document.getElementById('pali-input').value = ''; createSentenceTable.innerHTML = ''; createDataWorkArea.style.display = 'none'; } else { document.getElementById('group-results').innerHTML = ''; editViewContent.style.display = 'none'; } } catch (error) { updateStatus(statusElId, `บันทึกไม่สำเร็จ: ${error.message}`, 'error'); document.getElementById(saveBtnId).disabled = false; } }
        async function searchGroupsToEdit() { const storyName = document.getElementById('search_story_name').value.trim(); const pageNum = parseInt(document.getElementById('search_page_num').value.trim()); if (!storyName && !pageNum) { alert('กรุณาเลือกชื่อเรื่อง หรือใส่เลขหน้า'); return; } updateStatus('edit-status-message', 'กำลังค้นหากลุ่ม...', 'loading'); const groupResultsDiv = document.getElementById('group-results'); groupResultsDiv.innerHTML = ''; editViewContent.style.display = 'none'; try { let constraints = [ where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart), orderBy("sentence_group_id") ]; if (storyName) constraints.push(where("story_name", "==", storyName)); if (pageNum) constraints.push(where("page_start", "==", pageNum)); const q = query(paliCollection, ...constraints); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { throw new Error('ไม่พบข้อมูลตามเงื่อนไข'); } const groups = new Map(); querySnapshot.forEach(doc => { const data = doc.data(); if (!groups.has(data.sentence_group_id)) { groups.set(data.sentence_group_id, { pali_text: data.pali_text.substring(0, 50) + '...', status: data.translation_status || 'untranslated' }); } }); updateStatus('edit-status-message', `พบ ${groups.size} กลุ่ม, กรุณาเลือกกลุ่มที่ต้องการแก้ไข`, 'success'); groups.forEach((data, groupId) => { const div = document.createElement('div'); const statusClass = `status-${data.status}`; div.innerHTML = `<span>Group ID: ${groupId} (ตัวอย่าง: ${data.pali_text})</span> <span class="status-badge ${statusClass}">${data.status}</span>`; div.dataset.groupId = groupId; div.addEventListener('click', () => fetchDataForEdit(groupId)); groupResultsDiv.appendChild(div); }); } catch (error) { updateStatus('edit-status-message', `ค้นหาไม่สำเร็จ: ${error.message}`, 'error'); } }
        async function fetchDataForEdit(groupId) { if (!groupId) return; editViewContent.style.display = 'grid'; document.getElementById('group-results').innerHTML = ''; updateStatus('edit-status-message', `กำลังดึงข้อมูล Group ID: ${groupId}...`, 'loading'); try { const q = query(paliCollection, where("sentence_group_id", "==", groupId), orderBy("pali_order")); const querySnapshot = await getDocs(q); const data = querySnapshot.docs.map(doc => doc.data()); const paliDisplayText = document.getElementById('pali-display-text'); paliDisplayText.innerHTML = ''; data.forEach(item => { const p = document.createElement('p'); p.id = `pali-ref-${item.id}`; p.innerHTML = `<b>(ลำดับ ${item.pali_order})</b> ${item.pali_text}`; paliDisplayText.appendChild(p); }); document.getElementById('pali-display-header').textContent = `เนื้อหาบาลี (Group: ${groupId})`; generateEditTable(data); } catch (error) { updateStatus('edit-status-message', `เกิดข้อผิดพลาด: ${error.message}`, 'error'); } }
        function generateEditTable(data) { const table = editSentenceTable; table.innerHTML = editHeader; const tbody = table.querySelector('tbody'); data.forEach(item => { const row = tbody.insertRow(); row.dataset.id = item.id; row.dataset.refId = `pali-ref-${item.id}`; row.innerHTML = `<td class="id-cell">${item.id}</td><td style="text-align:center;">${item.pali_order || '-'}</td><td><div class="pali-text-display">${item.pali_text}</div></td><td><input type="number" class="thai-order-input" value="${item.thai_order || item.pali_order || ''}"></td><td><textarea class="thai-text-input" rows="3">${item.thai_text || ''}</textarea></td>`; row.querySelectorAll('input, textarea').forEach(input => { input.addEventListener('focus', () => { document.querySelectorAll('#pali-display-text p').forEach(p => p.classList.remove('highlight')); const refEl = document.getElementById(row.dataset.refId); if(refEl) refEl.classList.add('highlight'); }); }); }); editSaveBtn.disabled = false; updateStatus('edit-status-message', `พร้อมแก้ไข ${data.length} รายการ`, 'success'); }
        async function populateStoryDatalistForSearch(){ try { const q = query(paliCollection, where("book_title", "==", currentBookName), where("book_part", "==", currentBookPart)); const querySnapshot = await getDocs(q); const stories = new Set(); querySnapshot.forEach(doc => { const storyName = doc.data().story_name; if (storyName) stories.add(storyName); }); const datalistElement = document.getElementById('story_name_datalist_for_search'); datalistElement.innerHTML = ''; Array.from(stories).sort().forEach(story => { const option = document.createElement('option'); option.value = story; datalistElement.appendChild(option); }); } catch(error) { console.error("Could not populate story datalist:", error); } }
        
        initializeTool();
    });
</script>
</body>
</html>